<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤ç¥­ã‚Š è‹±å˜èªå°„çš„ (Lesson 9)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Reggae+One&family=M_PLUS_Rounded_1c:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background-color: #1a1a2e; /* å¤œç©ºã®è‰² */
            background-image: radial-gradient(#2d2d44 1px, transparent 1px);
            background-size: 20px 20px;
            overflow: hidden;
            touch-action: manipulation;
        }

        /* å’Œé¢¨ãƒ•ã‚©ãƒ³ãƒˆ */
        .japanese-font {
            font-family: 'Reggae One', cursive;
        }

        /* æç¯ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes swing {
            0% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
            100% { transform: rotate(-5deg); }
        }
        .lantern {
            animation: swing 3s infinite ease-in-out;
            transform-origin: top center;
        }

        /* ã‚¿ãƒ¼ã‚²ãƒƒãƒˆï¼ˆæœ¨ã®æœ­ï¼‰ */
        .target-card {
            background: #e6b422; /* é‡‘è‰²ã£ã½ã„æœ¨ */
            background: linear-gradient(to bottom, #f3d060, #c49a03);
            border: 2px solid #5c4033;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            position: absolute;
            transition: transform 0.2s, opacity 0.2s;
            white-space: nowrap;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            width: 160px; 
            height: 90px;
            overflow: hidden;
        }
        .target-card::before {
            content: '';
            position: absolute;
            top: -10px;
            width: 20px;
            height: 20px;
            background-color: #d1d5db; /* ç´ã®è‰² */
            border-radius: 50%;
            z-index: -1;
        }

        /* å¼¾ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .bullet {
            position: absolute;
            width: 16px;
            height: 16px;
            background-color: #fff;
            border-radius: 50%;
            box-shadow: 0 0 10px #fff, 0 0 20px #ff00de;
            z-index: 100; 
            pointer-events: none;
            transition: all 0.4s linear; /* ç­‰é€Ÿç›´ç·šé‹å‹•ã®æ–¹ãŒç‹™ã£ã¦ã‚‹æ„ŸãŒå‡ºã‚‹ */
        }

        /* ç ´å£Šã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ï¼‰ */
        .particle {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 110;
        }
        
        /* ãƒ’ãƒƒãƒˆæ™‚ã®ã‚¹ã‚³ã‚¢è¡¨ç¤º */
        .score-popup {
            position: absolute;
            color: #ffeb3b;
            font-weight: bold;
            font-size: 2rem;
            text-shadow: 2px 2px 0 #000;
            pointer-events: none;
            z-index: 120;
            animation: score-float 0.8s ease-out forwards;
        }
        @keyframes score-float {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            50% { transform: translateY(-30px) scale(1.2); opacity: 1; }
            100% { transform: translateY(-60px) scale(1); opacity: 0; }
        }

        /* å…¥åŠ›ã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .wood-panel {
            background-color: #8b5a2b;
            background-image: repeating-linear-gradient(45deg, rgba(0,0,0,0.05) 0px, rgba(0,0,0,0.05) 2px, transparent 2px, transparent 4px);
            border-top: 4px solid #5c3a1e;
        }
        
        /* éŸ³å£°èªè­˜ä¸­ã®æ³¢å½¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes pulse-ring {
            0% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(255, 82, 82, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(255, 82, 82, 0); }
            100% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(255, 82, 82, 0); }
        }
        .listening {
            animation: pulse-ring 1.5s infinite;
            background-color: #ff5252 !important;
        }

        /* å¥¥è¡Œãæ„Ÿã‚’å‡ºã™ãŸã‚ã®èƒŒæ™¯ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³èª¿æ•´ */
        .depth-overlay {
            background: linear-gradient(to bottom, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0) 100%);
            pointer-events: none;
        }
        
        /* é•·ã„æ—¥æœ¬èªã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºèª¿æ•´ */
        .text-adjust { font-size: 1.1rem; }
        .text-adjust-small { font-size: 0.9rem; }
        .text-adjust-tiny { font-size: 0.75rem; }

        /* å¤§ç ²ï¼ˆéŠƒï¼‰ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        #cannon-base {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 80px;
            background: #4a4a4a;
            border-radius: 50% 50% 0 0;
            z-index: 40;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.5);
        }
        #cannon-barrel-wrapper {
            position: absolute;
            bottom: 20px; /* å¤§ç ²ã®å›è»¢è»¸ */
            left: 50%;
            width: 0;
            height: 0;
            z-index: 39;
            transition: transform 0.1s ease-out;
        }
        #cannon-barrel {
            position: absolute;
            bottom: 0;
            left: -12px;
            width: 24px;
            height: 80px;
            background: linear-gradient(90deg, #333, #666, #333);
            border: 2px solid #222;
            border-radius: 4px 4px 0 0;
            transform-origin: center bottom;
        }
        /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å…±é€š */
        .overlay-screen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 9999;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        /* BGMãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
        .bgm-btn-on { @apply text-yellow-400 border-yellow-400; }
        .bgm-btn-off { @apply text-gray-500 border-gray-500; }

        /* ä»®æƒ³ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .key-btn {
            @apply bg-gray-700 text-white rounded font-bold shadow active:bg-gray-600 select-none touch-manipulation;
            height: 40px;
        }
        .key-btn:active {
            transform: translateY(2px);
            box-shadow: none;
        }
        
        /* ç§°å·ãƒãƒƒã‚¸ */
        .title-badge {
            background: linear-gradient(135deg, #b91c1c 0%, #7f1d1d 100%);
            border: 2px solid #fcd34d;
            box-shadow: 0 4px 6px rgba(0,0,0,0.5);
            padding: 0.5rem 1.5rem;
            border-radius: 9999px;
            transform: rotate(-2deg);
            /* animation: badge-pulse 2s infinite; ã“ã‚Œã‚’å‰Šé™¤ã—ã¦ç‹¬è‡ªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã¸ */
        }
        
        /* ç©ã‚„ã‹ãªæµ®éŠã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .gentle-float {
            animation: gentle-float 3s ease-in-out infinite;
        }
        @keyframes gentle-float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
    </style>
</head>
<body class="h-screen flex flex-col text-white">

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="relative z-10 bg-opacity-80 bg-black pt-2 pb-4 shadow-lg border-b-4 border-red-800 flex-shrink-0">
        <!-- æç¯è£…é£¾ -->
        <div class="absolute top-0 left-0 w-full flex justify-around pointer-events-none -mt-2">
            <div class="lantern w-12 h-16 bg-red-600 rounded-lg border-t-8 border-b-8 border-black flex items-center justify-center shadow-lg"><span class="text-black font-bold text-xl japanese-font">ç¥­</span></div>
            <div class="lantern w-12 h-16 bg-white rounded-lg border-t-8 border-b-8 border-black flex items-center justify-center shadow-lg animation-delay-500"><span class="text-red-600 font-bold text-xl japanese-font">å°„</span></div>
            <div class="lantern w-12 h-16 bg-red-600 rounded-lg border-t-8 border-b-8 border-black flex items-center justify-center shadow-lg animation-delay-1000"><span class="text-black font-bold text-xl japanese-font">çš„</span></div>
            <div class="lantern w-12 h-16 bg-white rounded-lg border-t-8 border-b-8 border-black flex items-center justify-center shadow-lg animation-delay-1500"><span class="text-red-600 font-bold text-xl japanese-font">è‹±</span></div>
        </div>

        <div class="container mx-auto px-4 mt-12 grid grid-cols-3 items-end relative">
            <!-- ã‚¹ã‚³ã‚¢ -->
            <div class="text-left">
                <div class="text-sm text-gray-400">Score</div>
                <div class="text-3xl font-bold text-yellow-400 font-mono" id="score">0</div>
            </div>
            
            <!-- ã‚¿ã‚¤ãƒˆãƒ« & ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            <div class="text-center flex flex-col items-center justify-end">
                <h1 class="text-xl font-bold japanese-font tracking-widest text-red-100 drop-shadow-md whitespace-nowrap">Lesson 9</h1>
                <div class="text-sm text-yellow-200 h-6 leading-6 font-bold truncate w-full" id="game-message"></div>
            </div>

            <!-- æ™‚é–“ & BGMãƒœã‚¿ãƒ³ -->
            <div class="text-right flex flex-col items-end justify-end">
                <div class="mb-1 hidden md:block">
                    <!-- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆON -->
                     <button id="bgm-toggle" class="border-2 rounded-full px-2 py-0.5 text-xs font-bold transition-colors bgm-btn-on" onclick="toggleBGM()">
                        ğŸµ BGM ON
                    </button>
                </div>
                <div>
                    <span class="text-sm text-gray-400 mr-1">Time</span>
                    <span class="text-3xl font-bold text-white font-mono" id="time">60</span>
                </div>
            </div>
        </div>
        
        <!-- ã‚¹ãƒãƒ›ç”¨BGMã‚¹ã‚¤ãƒƒãƒ (çµ¶å¯¾é…ç½®) -->
        <div class="absolute top-2 right-2 md:hidden">
             <button id="bgm-toggle-mobile" class="border rounded-full p-1 text-xs transition-colors bgm-btn-on" onclick="toggleBGM()">ğŸµ</button>
        </div>
    </div>

    <!-- ã‚²ãƒ¼ãƒ ã‚¨ãƒªã‚¢ -->
    <div id="game-area" class="flex-grow relative overflow-hidden cursor-crosshair bg-gray-900 min-h-0">
        <!-- å¥¥è¡Œãã‚·ãƒ£ãƒ‰ã‚¦ -->
        <div class="absolute inset-0 depth-overlay z-0"></div>

        <!-- èƒŒæ™¯ã®æ£š -->
        <div class="absolute inset-x-0 top-[25%] h-1 bg-yellow-900 shadow-md opacity-40 z-0"></div> <!-- å¥¥ -->
        <div class="absolute inset-x-0 top-[45%] h-2 bg-yellow-900 shadow-md opacity-50 z-0"></div> <!-- ä¸­ -->
        <div class="absolute inset-x-0 top-[65%] h-3 bg-yellow-900 shadow-md opacity-60 z-0"></div> <!-- æ‰‹å‰ -->
        
        <!-- å¤§ç ² -->
        <div id="cannon-container" class="absolute bottom-0 left-1/2 transform -translate-x-1/2 pointer-events-none z-40">
             <div id="cannon-barrel-wrapper">
                 <div id="cannon-barrel"></div>
             </div>
             <div id="cannon-base" class="flex items-center justify-center border-t-4 border-gray-600">
                 <span class="text-yellow-500 font-bold text-2xl japanese-font mt-2">ç¥­</span>
             </div>
        </div>

        <div id="targets-container" class="absolute inset-0 pointer-events-none z-10"></div>
        <div id="effects-container" class="absolute inset-0 pointer-events-none z-50"></div>
    </div>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <div class="wood-panel p-4 pb-2 relative z-20 flex-shrink-0">
        <div class="max-w-3xl mx-auto flex items-center gap-2 mb-2">
            <div class="flex-grow relative flex gap-2">
                <input type="text" id="answer-input" autocomplete="off" placeholder="ã“ã“ã«è‹±èªã‚’å…¥åŠ›" 
                    class="w-full bg-white text-gray-900 px-4 py-3 rounded-lg border-4 border-gray-300 focus:border-red-500 focus:outline-none text-xl font-bold shadow-inner"
                    onkeydown="checkEnter(event)">
                
                <button onclick="toggleVirtualKeyboard()" class="bg-gray-700 hover:bg-gray-600 text-white px-3 rounded-lg border-2 border-gray-500 flex items-center justify-center shadow-md active:translate-y-1 transition" title="ç”»é¢ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰">
                    <span class="text-2xl">âŒ¨ï¸</span>
                </button>

                <button onclick="checkAnswer()" class="bg-blue-500 hover:bg-blue-600 text-white rounded px-4 font-bold md:hidden shadow-md active:translate-y-1 transition">
                    æ’ƒã¤
                </button>
            </div>
            <button id="mic-btn" onclick="toggleSpeech()" class="bg-gray-700 hover:bg-gray-600 text-white p-3 rounded-full shadow-lg transition-all border-2 border-gray-500 flex-shrink-0" title="éŸ³å£°å…¥åŠ›">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                </svg>
            </button>
        </div>
        <div class="text-center mb-2 text-xs text-yellow-100 opacity-70">
            éŸ³å£°èªè­˜: <span id="speech-status">OFF</span>
        </div>

        <!-- ä»®æƒ³ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ -->
        <div id="virtual-keyboard" class="hidden w-full max-w-3xl mx-auto pt-2 pb-1 border-t border-yellow-900/30">
            <div class="flex flex-col gap-1">
                <div class="flex gap-1 justify-center">
                    <button class="key-btn w-[9%]" onclick="vKey('q')">Q</button>
                    <button class="key-btn w-[9%]" onclick="vKey('w')">W</button>
                    <button class="key-btn w-[9%]" onclick="vKey('e')">E</button>
                    <button class="key-btn w-[9%]" onclick="vKey('r')">R</button>
                    <button class="key-btn w-[9%]" onclick="vKey('t')">T</button>
                    <button class="key-btn w-[9%]" onclick="vKey('y')">Y</button>
                    <button class="key-btn w-[9%]" onclick="vKey('u')">U</button>
                    <button class="key-btn w-[9%]" onclick="vKey('i')">I</button>
                    <button class="key-btn w-[9%]" onclick="vKey('o')">O</button>
                    <button class="key-btn w-[9%]" onclick="vKey('p')">P</button>
                </div>
                <div class="flex gap-1 justify-center">
                    <button class="key-btn w-[9%]" onclick="vKey('a')">A</button>
                    <button class="key-btn w-[9%]" onclick="vKey('s')">S</button>
                    <button class="key-btn w-[9%]" onclick="vKey('d')">D</button>
                    <button class="key-btn w-[9%]" onclick="vKey('f')">F</button>
                    <button class="key-btn w-[9%]" onclick="vKey('g')">G</button>
                    <button class="key-btn w-[9%]" onclick="vKey('h')">H</button>
                    <button class="key-btn w-[9%]" onclick="vKey('j')">J</button>
                    <button class="key-btn w-[9%]" onclick="vKey('k')">K</button>
                    <button class="key-btn w-[9%]" onclick="vKey('l')">L</button>
                </div>
                <div class="flex gap-1 justify-center">
                    <button class="key-btn w-[12%] bg-gray-600" onclick="vKey('BS')">âŒ«</button>
                    <button class="key-btn w-[9%]" onclick="vKey('z')">Z</button>
                    <button class="key-btn w-[9%]" onclick="vKey('x')">X</button>
                    <button class="key-btn w-[9%]" onclick="vKey('c')">C</button>
                    <button class="key-btn w-[9%]" onclick="vKey('v')">V</button>
                    <button class="key-btn w-[9%]" onclick="vKey('b')">B</button>
                    <button class="key-btn w-[9%]" onclick="vKey('n')">N</button>
                    <button class="key-btn w-[9%]" onclick="vKey('m')">M</button>
                    <button class="key-btn w-[15%] bg-blue-600" onclick="vKey('ENTER')">Enter</button>
                </div>
                 <div class="flex gap-1 justify-center">
                    <button class="key-btn w-[40%]" onclick="vKey(' ')">Space</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ã‚¹ã‚¿ãƒ¼ãƒˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="start-overlay" class="overlay-screen">
        <h2 class="text-4xl md:text-6xl font-bold text-yellow-400 japanese-font mb-2 drop-shadow-[0_0_10px_rgba(255,215,0,0.8)]">å°„çš„é–‹å§‹</h2>
        
        <!-- ç¾åœ¨ã®ç§°å·è¡¨ç¤º (ã‚µã‚¤ã‚ºèª¿æ•´ãƒ»ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¤‰æ›´) -->
        <div id="best-rank-display" class="mb-6 text-center gentle-float">
            <div class="text-sm text-gray-300 mb-1">ç¾åœ¨ã®æœ€é«˜ç§°å·</div>
            <div id="current-title" class="title-badge text-xl md:text-2xl font-bold text-white japanese-font">
                è¦‹ç¿’ã„ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ£ãƒ¼ ğŸ¥š
            </div>
        </div>

        <div class="flex flex-col gap-3 w-full max-w-sm px-4">
            <!-- è¨­å®šï¼šå‡ºé¡Œç¯„å›² -->
            <div class="flex flex-col">
                 <label class="text-sm text-gray-400 mb-1">å‡ºé¡Œç¯„å›²</label>
                 <select id="part-selector" class="bg-gray-800 text-white border border-gray-600 rounded px-4 py-2 text-lg">
                     <option value="part1">Lesson 9 Part 1</option>
                     <option value="part2">Lesson 9 Part 2</option>
                     <option value="part3">Lesson 9 Part 3</option>
                     <option value="all" selected>Lesson 9 ã™ã¹ã¦</option>
                 </select>
            </div>
            
            <!-- è¨­å®šï¼šãƒ¢ãƒ¼ãƒ‰é¸æŠ -->
            <div class="flex flex-col">
                <label class="text-sm text-gray-400 mb-1">ãƒ¢ãƒ¼ãƒ‰</label>
                <div class="flex gap-2">
                    <label class="flex-1 cursor-pointer">
                        <input type="radio" name="game-mode" value="ja_to_en" checked class="hidden peer">
                        <div class="border border-gray-500 rounded p-2 text-center peer-checked:bg-red-900 peer-checked:border-red-500 peer-checked:text-white text-gray-400 hover:bg-gray-800 transition">
                            <div class="font-bold">ç¿»è¨³ (æ—¥â†’è‹±)</div>
                            <div class="text-xs">æ¨™æº–ãƒ¢ãƒ¼ãƒ‰</div>
                        </div>
                    </label>
                    <label class="flex-1 cursor-pointer">
                        <input type="radio" name="game-mode" value="en_to_en" class="hidden peer">
                        <div class="border border-gray-500 rounded p-2 text-center peer-checked:bg-blue-900 peer-checked:border-blue-500 peer-checked:text-white text-gray-400 hover:bg-gray-800 transition">
                            <div class="font-bold">è¦–å†™ (è‹±â†’è‹±)</div>
                            <div class="text-xs">åˆå¿ƒè€…å‘ã‘</div>
                        </div>
                    </label>
                </div>
            </div>

            <button onclick="startGame()" class="mt-4 bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-full text-xl shadow-[0_4px_0_rgb(153,27,27)] active:shadow-none active:translate-y-1 transition japanese-font">
                ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ
            </button>
        </div>

        <!-- ãƒ­ãƒ¼ã‚«ãƒ«ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div class="mt-6 w-full max-w-sm">
            <h3 class="text-center text-yellow-400 font-bold mb-2 border-b border-gray-600 pb-1">Best Scores (Top 5)</h3>
            <ul id="local-ranking-list" class="text-sm text-gray-300 space-y-1">
                <!-- JSã§ç”Ÿæˆ -->
            </ul>
        </div>
    </div>

    <!-- ãƒªã‚¶ãƒ«ãƒˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="result-overlay" class="overlay-screen hidden">
        <h2 class="text-6xl font-bold text-yellow-400 japanese-font mb-4">çµ‚äº†ï¼</h2>
        <div id="result-content" class="text-center mb-6">
            <!-- JSã§æŒ¿å…¥ -->
        </div>
        <button onclick="resetGame()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-12 rounded-full text-xl shadow-[0_4px_0_rgb(153,27,27)] active:shadow-none active:translate-y-1 transition japanese-font">
            ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹
        </button>
    </div>

    <script>
        // --- ãƒ‡ãƒ¼ã‚¿ç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯ (ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ã¿) ---
        const STORAGE_KEY = 'shooting_game_scores_v2'; // åå‰ãªã—ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã—ã¦ã‚­ãƒ¼å¤‰æ›´

        function saveScoreLocal(score) {
            // å˜ç´”ã«ã‚¹ã‚³ã‚¢ã¨æ—¥ä»˜ã®é…åˆ—ã¨ã—ã¦ä¿å­˜
            const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            data.push({
                score: score,
                timestamp: new Date().toISOString()
            });
            // ã‚½ãƒ¼ãƒˆã—ã¦ä¸Šä½10ä»¶ã ã‘æ®‹ã™
            data.sort((a, b) => b.score - a.score);
            const top10 = data.slice(0, 10);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(top10));
        }

        function getLocalScores() {
            return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        }

        function renderLocalRanking() {
            const list = document.getElementById('local-ranking-list');
            const data = getLocalScores();
            
            list.innerHTML = '';
            if (data.length === 0) {
                list.innerHTML = '<li class="text-center text-gray-500">- No Data -</li>';
                updateBestRankDisplay(0); // ãƒ‡ãƒ¼ã‚¿ãªã—ãªã‚‰åˆæœŸç§°å·
                return;
            }

            // Top 5 è¡¨ç¤º
            data.slice(0, 5).forEach((item, index) => {
                const date = new Date(item.timestamp);
                const dateStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
                const rankIcon = index === 0 ? 'ğŸ¥‡' : (index === 1 ? 'ğŸ¥ˆ' : (index === 2 ? 'ğŸ¥‰' : `${index + 1}.`));
                const colorClass = index === 0 ? 'text-yellow-300 font-bold' : 'text-gray-300';
                
                const li = document.createElement('li');
                li.className = `flex justify-between ${colorClass}`;
                li.innerHTML = `
                    <span>${rankIcon} ${item.score}pts</span>
                    <span class="text-xs text-gray-500">${dateStr}</span>
                `;
                list.appendChild(li);
            });

            // ãƒã‚¤ã‚¹ã‚³ã‚¢ã«åŸºã¥ã„ã¦ç§°å·æ›´æ–°
            updateBestRankDisplay(data[0].score);
        }

        function updateBestRankDisplay(highScore) {
            const title = getRank(highScore);
            const el = document.getElementById('current-title');
            el.innerText = title;
        }

        // --- ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ ---

        function startGame() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const part = document.getElementById('part-selector').value;
            const modeRadios = document.getElementsByName('game-mode');
            for(const radio of modeRadios) if(radio.checked) gameMode = radio.value;

            if (part === 'all') currentWords = [...wordData.part1, ...wordData.part2, ...wordData.part3];
            else currentWords = [...wordData[part]];
            
            score = 0;
            timeLeft = 60;
            targets = [];
            targetsContainer.innerHTML = '';
            effectsContainer.innerHTML = '';
            scoreEl.innerText = score;
            timeEl.innerText = timeLeft;
            input.value = '';
            input.focus();
            cannonWrapper.style.transform = 'rotate(0deg)';
            document.getElementById('start-overlay').style.display = 'none';
            document.getElementById('result-overlay').style.display = 'none';
            isGameRunning = true;
            messageEl.innerText = "";

            clearInterval(gameInterval);
            gameInterval = setInterval(updateGame, 20); 
            
            clearInterval(spawnInterval);
            const spawnRate = 4000; 
            spawnInterval = setInterval(spawnTarget, spawnRate);

            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                timeEl.innerText = timeLeft;
                if (timeLeft <= 0) endGame();
            }, 1000);
            
            if(isBgmOn) startBGM();

            if(isVirtualKeyboardOn) input.setAttribute('readonly', 'readonly');
        }

        function resetGame() {
            document.getElementById('result-overlay').style.display = 'none';
            document.getElementById('start-overlay').style.display = 'flex';
            // ãƒ©ãƒ³ã‚­ãƒ³ã‚°å†æç”»
            renderLocalRanking();
        }

        function getRank(score) {
            if (score >= 2000) return "Lv.10 ä¼èª¬ã®çš„å±‹ç‹ ğŸ†ğŸ‘‘";
            if (score >= 1800) return "Lv.9 å¥‡è·¡ã®ã‚¹ãƒŠã‚¤ãƒ‘ãƒ¼ ğŸ¯âœ¨";
            if (score >= 1500) return "Lv.8 å¤ç¥­ã‚Šã®è¦‡è€… ğŸ®ğŸ¦";
            if (score >= 1200) return "Lv.7 å°„çš„ãƒã‚¹ã‚¿ãƒ¼ ğŸ”¥ğŸ”«";
            if (score >= 1000) return "Lv.6 ãŠç¥­ã‚Šåäºº ğŸ‘ºğŸ®";
            if (score >= 800)  return "Lv.5 å‡„è…•ãƒãƒ³ã‚¿ãƒ¼ ğŸº";
            if (score >= 600)  return "Lv.4 ç†Ÿç·´ã®å°„æ‰‹ ğŸ¹";
            if (score >= 400)  return "Lv.3 æœŸå¾…ã®ãƒ›ãƒ¼ãƒ— âœ¨";
            if (score >= 200)  return "Lv.2 é§†ã‘å‡ºã—ãƒ«ãƒ¼ã‚­ãƒ¼ ğŸ”°";
            return "Lv.1 è¦‹ç¿’ã„ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ£ãƒ¼ ğŸ¥š";
        }

        function endGame() {
            isGameRunning = false;
            clearInterval(gameInterval);
            clearInterval(spawnInterval);
            clearInterval(timerInterval);
            if(isListening) toggleSpeech();
            stopBGM();
            
            // ã‚¹ã‚³ã‚¢ä¿å­˜
            saveScoreLocal(score);

            const rank = getRank(score);
            const overlay = document.getElementById('result-overlay');
            overlay.style.display = 'flex';
            
            const content = document.getElementById('result-content');
            content.innerHTML = `
                <div class="text-xl mb-2">ä»Šå›ã®ã‚¹ã‚³ã‚¢</div>
                <div class="text-yellow-400 text-6xl font-bold font-mono mb-4">${score}</div>
                <div class="text-2xl mt-2 bg-red-900 bg-opacity-50 px-6 py-2 rounded-lg border border-red-500 inline-block">
                    ç§°å·: <span class="text-white font-bold japanese-font">${rank}</span>
                </div>
            `;
        }

        // --- ä»¥ä¸‹ã€æ—¢å­˜ã®ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ãƒ»å¤‰æ•°å®šç¾©ãªã© ---
        
        const wordData = {
            part1: [
                { ja: 'ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚­ãƒ£ã‚¹ã‚¿ãƒ¼', en: 'newscaster' },
                { ja: 'è¦³è¡†', en: 'spectator' },
                { ja: 'ã˜ã£ã¨è¦‹ã‚‹', en: 'stare' },
                { ja: 'ç”»é¢, ã‚¹ã‚¯ãƒªãƒ¼ãƒ³', en: 'screen' },
                { ja: 'ä¼šå ´', en: 'venue' },
                { ja: 'ãƒ­ã‚±ãƒƒãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã®', en: 'rocket-powered' },
                { ja: 'å‚åŠ ã™ã‚‹', en: 'participate' },
                { ja: 'ï¼ˆä¼šç¤¾ãƒ»çµ„ç¹”ãªã©ï¼‰ã‚’è¨­ç«‹ã™ã‚‹', en: 'set up' },
                { ja: 'ï½ã‚’å¿œæ´ã™ã‚‹', en: 'cheer for' },
                { ja: 'ç«¶ã†', en: 'compete' }
            ],
            part2: [
                { ja: 'â€¦ã®ç•¥èªã§', en: 'short for' },
                { ja: 'â€¦ã‚’æŒ‡ã™', en: 'refer to' },
                { ja: 'çµ„ç¹”ã•ã‚ŒãŸ', en: 'organized' },
                { ja: 'ç”¨èª', en: 'term' },
                { ja: 'äººæ°—', en: 'popularity' },
                { ja: 'å…¬å¼ã®', en: 'official' },
                { ja: 'æ€¥æ¿€ã«', en: 'sharply' },
                { ja: 'å¥¨å­¦é‡‘', en: 'scholarship' },
                { ja: 'å¤§ä¼š', en: 'competition' },
                { ja: 'å§”å“¡ä¼š', en: 'committee' }
            ],
            part3: [
                { ja: 'â€¦ã‚’æ€ã„ã¤ã', en: 'think of' },
                { ja: 'ã‚³ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚¿ãƒ¼', en: 'commentator' },
                { ja: 'èº«ä½“çš„ãª', en: 'physical' },
                { ja: 'ç²¾ç¥çš„ãª', en: 'mental' },
                { ja: 'ç´ æ—©ã„', en: 'quick' },
                { ja: 'åå¿œ', en: 'response' },
                { ja: 'é›†ä¸­', en: 'concentration' },
                { ja: 'æˆ¦ç•¥', en: 'strategy' },
                { ja: 'ãƒ“ã‚¶', en: 'visa' },
                { ja: 'åˆ©ç‚¹', en: 'advantage' },
                { ja: 'â€¦ã«é–¢ä¿‚ãªã', en: 'regardless of' },
                { ja: 'ãƒãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯', en: 'teamwork' },
                { ja: 'â€¦ã ã‘ã‚Œã©ã‚‚', en: 'although' },
                { ja: 'å¿ƒé…ã—ã¦, (æã‚Œã¦)', en: 'afraid' },
                { ja: 'ç„¡é§„', en: 'waste' },
                { ja: 'æ”¿åºœ', en: 'government' },
                { ja: 'èªã‚ã‚‹', en: 'recognize' },
                { ja: 'åŠ›', en: 'strength' }
            ]
        };

        // --- å¤‰æ•° ---
        let currentWords = [];
        let targets = [];
        let score = 0;
        let timeLeft = 60;
        let gameInterval;
        let spawnInterval;
        let timerInterval;
        let isGameRunning = false;
        let speechRecognition;
        let isListening = false;
        let isBgmOn = true; 
        let bgmInterval;
        let gameMode = 'ja_to_en'; 
        let isVirtualKeyboardOn = false;
        
        // DOMè¦ç´ 
        const gameArea = document.getElementById('game-area');
        const targetsContainer = document.getElementById('targets-container');
        const effectsContainer = document.getElementById('effects-container');
        const input = document.getElementById('answer-input');
        const scoreEl = document.getElementById('score');
        const timeEl = document.getElementById('time');
        const messageEl = document.getElementById('game-message');
        const micBtn = document.getElementById('mic-btn');
        const speechStatus = document.getElementById('speech-status');
        const cannonWrapper = document.getElementById('cannon-barrel-wrapper');

        // éŸ³å£°èªè­˜
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            speechRecognition = new SpeechRecognition();
            speechRecognition.lang = 'en-US'; 
            speechRecognition.continuous = true; 
            speechRecognition.interimResults = false;
            speechRecognition.onresult = (event) => {
                const last = event.results.length - 1;
                // ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ã®ã¿ï¼ˆãƒã‚¤ãƒ•ãƒ³é™¤å»ã¯ã—ãªã„ã€rawã‚’é€ã‚‹ï¼‰
                const transcript = event.results[last][0].transcript.trim().toLowerCase().replace(/[.?]/g, '');
                input.value = transcript;
                checkAnswer(true); 
                messageEl.innerText = `éŸ³å£°èªè­˜: ${transcript}`;
                messageEl.classList.remove('text-yellow-200');
                messageEl.classList.add('text-green-300');
                setTimeout(() => {
                    if(messageEl.innerText.includes(transcript)) {
                        messageEl.innerText = '';
                        messageEl.classList.add('text-yellow-200');
                        messageEl.classList.remove('text-green-300');
                    }
                }, 2000);
            };
            speechRecognition.onend = () => {
                if (isListening && isGameRunning) speechRecognition.start();
                else { isListening = false; updateMicUI(); }
            };
            speechRecognition.onerror = (event) => {
                if(event.error === 'not-allowed') {
                    showToast("ãƒã‚¤ã‚¯ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“");
                    isListening = false;
                    updateMicUI();
                }
            };
        } else {
            micBtn.style.display = 'none';
            speechStatus.innerText = "éå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶";
        }

        function toggleSpeech() {
            if (!speechRecognition) return;
            if (isListening) { isListening = false; speechRecognition.stop(); }
            else { isListening = true; speechRecognition.start(); }
            updateMicUI();
        }

        function updateMicUI() {
            if (isListening) {
                micBtn.classList.add('listening');
                speechStatus.innerText = "ON (è©±ã—ã¦ãã ã•ã„)";
                speechStatus.classList.add('text-red-400');
            } else {
                micBtn.classList.remove('listening');
                speechStatus.innerText = "OFF";
                speechStatus.classList.remove('text-red-400');
            }
        }

        function showToast(msg) {
            const toast = document.createElement('div');
            toast.className = 'absolute bottom-24 left-1/2 transform -translate-x-1/2 bg-black bg-opacity-70 text-white px-4 py-2 rounded pointer-events-none transition-opacity duration-500 z-[100]';
            toast.innerText = msg;
            gameArea.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 500);
            }, 1500);
        }

        // --- ç”»é¢ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ ---
        function toggleVirtualKeyboard() {
            isVirtualKeyboardOn = !isVirtualKeyboardOn;
            const kb = document.getElementById('virtual-keyboard');
            
            if (isVirtualKeyboardOn) {
                kb.classList.remove('hidden');
                input.setAttribute('readonly', 'readonly');
            } else {
                kb.classList.add('hidden');
                input.removeAttribute('readonly');
            }
            input.blur();
        }

        function vKey(key) {
            if (key === 'ENTER') {
                checkAnswer();
            } else if (key === 'BS') {
                input.value = input.value.slice(0, -1);
            } else {
                input.value += key;
            }
            if(isVirtualKeyboardOn) {
                input.focus();
            }
        }


        // --- ã‚ªãƒ¼ãƒ‡ã‚£ã‚ª ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function toggleBGM() {
            isBgmOn = !isBgmOn;
            const btn = document.getElementById('bgm-toggle');
            const btnMobile = document.getElementById('bgm-toggle-mobile');
            
            if (isBgmOn) {
                if (audioCtx.state === 'suspended') audioCtx.resume();
                btn.innerText = "ğŸµ BGM ON";
                btn.classList.remove('bgm-btn-off'); btn.classList.add('bgm-btn-on');
                btnMobile.classList.remove('bgm-btn-off'); btnMobile.classList.add('bgm-btn-on');
                startBGM();
            } else {
                btn.innerText = "ğŸµ BGM OFF";
                btn.classList.remove('bgm-btn-on'); btn.classList.add('bgm-btn-off');
                btnMobile.classList.remove('bgm-btn-on'); btnMobile.classList.add('bgm-btn-off');
                stopBGM();
            }
        }

        function startBGM() {
            let beat = 0;
            const tempo = 130; 
            
            const melodyPattern = [
                1175, 987, 880, 0,  1175, 987, 880, 0,
                1175, 1175, 987, 987, 880, 0, 880, 0,
                1318, 0, 1318, 0, 1175, 987, 880, 0,
                987, 1175, 987, 880, 880, 0, 0, 0
            ];

            clearInterval(bgmInterval);
            bgmInterval = setInterval(() => {
                const t = audioCtx.currentTime;
                const step = beat % 32;

                const drumRhythm = [
                    1, 0, 1, 0, 1, 2, 0, 2,  
                    1, 0, 2, 0, 1, 0, 2, 0,  
                    1, 0, 1, 0, 1, 2, 0, 2,
                    1, 1, 2, 2, 1, 0, 0, 0   
                ];
                
                const d = drumRhythm[step];
                if (d === 1) playTaikoDon(t);
                if (d === 2) playTaikoKa(t);

                const note = melodyPattern[step];
                if (note) playShinobue(t, note, 0.15);

                beat++;
            }, tempo);
        }

        function stopBGM() { clearInterval(bgmInterval); }

        function playTaikoDon(time) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.setValueAtTime(120, time);
            osc.frequency.exponentialRampToValueAtTime(60, time + 0.15);
            gain.gain.setValueAtTime(0.6, time);
            gain.gain.exponentialRampToValueAtTime(0.01, time + 0.2);
            addNoiseBurst(time, 0.05, 0.1);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(time);
            osc.stop(time + 0.2);
        }

        function playTaikoKa(time) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'square';
            osc.frequency.setValueAtTime(400, time);
            gain.gain.setValueAtTime(0.1, time);
            gain.gain.exponentialRampToValueAtTime(0.01, time + 0.05);
            addNoiseBurst(time, 0.05, 0.2); 
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(time);
            osc.stop(time + 0.05);
        }

        function addNoiseBurst(time, duration, vol) {
            const bufferSize = audioCtx.sampleRate * duration;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
            const noise = audioCtx.createBufferSource();
            noise.buffer = buffer;
            const gain = audioCtx.createGain();
            gain.gain.setValueAtTime(vol, time);
            gain.gain.exponentialRampToValueAtTime(0.01, time + duration);
            noise.connect(gain);
            gain.connect(audioCtx.destination);
            noise.start(time);
        }

        function playShinobue(time, freq, dur) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            const lfo = audioCtx.createOscillator();
            const lfoGain = audioCtx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(freq, time);
            lfo.frequency.value = 5; 
            lfoGain.gain.value = 5; 
            lfo.connect(lfoGain);
            lfoGain.connect(osc.frequency);
            lfo.start(time);
            gain.gain.setValueAtTime(0, time);
            gain.gain.linearRampToValueAtTime(0.1, time + 0.05);
            gain.gain.linearRampToValueAtTime(0, time + dur); 
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(time);
            osc.stop(time + dur);
        }

        // --- åŠ¹æœéŸ³ ---
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const t = audioCtx.currentTime;
            
            if (type === 'hit') {
                addNoiseBurst(t, 0.4, 0.6);
            } else {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(300, t);
                osc.frequency.linearRampToValueAtTime(100, t + 0.2);
                gain.gain.setValueAtTime(0.1, t);
                gain.gain.exponentialRampToValueAtTime(0.01, t + 0.2);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start(t);
                osc.stop(t + 0.2);
            }
        }

        function spawnTarget() {
            if (!isGameRunning) return;
            const wordData = currentWords[Math.floor(Math.random() * currentWords.length)];
            const laneConfigs = [
                { top: '20%', scale: 0.7, zIndex: 1, speedRatio: 0.8 },
                { top: '40%', scale: 0.85, zIndex: 5, speedRatio: 0.9 },
                { top: '60%', scale: 1.0, zIndex: 10, speedRatio: 1.0 }
            ];
            const config = laneConfigs[Math.floor(Math.random() * laneConfigs.length)];
            const id = Date.now() + Math.random();
            const el = document.createElement('div');
            el.className = 'target-card px-2 py-1'; 
            el.style.top = config.top;
            el.style.left = '100%'; 
            el.style.transform = `scale(${config.scale})`;
            el.style.zIndex = config.zIndex;
            
            let mainText, subText, fontClass;
            if (gameMode === 'en_to_en') {
                mainText = wordData.en;
                subText = wordData.ja; 
                fontClass = "font-bold text-blue-900 mb-1 leading-tight font-sans"; 
            } else {
                mainText = wordData.ja;
                subText = wordData.en;
                fontClass = "font-bold text-red-900 japanese-font mb-1 leading-tight";
            }
            const len = mainText.length;
            if (len > 12) fontClass += " text-adjust-tiny";
            else if (len > 8) fontClass += " text-adjust-small";
            else fontClass += " text-xl";
            
            el.innerHTML = `<div class="${fontClass}">${mainText}</div><div class="text-xs text-yellow-900 opacity-0 debug-hint">${subText}</div>`;
            targetsContainer.appendChild(el);

            const baseSpeed = 0.16;
            targets.push({
                id: id, el: el, word: wordData, x: 100, 
                speed: baseSpeed * config.speedRatio, scale: config.scale, zIndex: config.zIndex
            });
        }

        function updateGame() {
            for (let i = targets.length - 1; i >= 0; i--) {
                let t = targets[i];
                t.x -= t.speed;
                t.el.style.left = t.x + '%';
                if (t.x < -20) { t.el.remove(); targets.splice(i, 1); }
            }
        }

        function checkEnter(e) { if (e.key === 'Enter') checkAnswer(); }

        // ãƒã‚¤ãƒ•ãƒ³ã¨ã‚¹ãƒšãƒ¼ã‚¹ã‚’æ­£è¦åŒ–ã™ã‚‹é–¢æ•°
        function normalizeString(str) {
            if (!str) return "";
            return str.toLowerCase()
                      .replace(/-/g, ' ')  // ãƒã‚¤ãƒ•ãƒ³ã‚’ã‚¹ãƒšãƒ¼ã‚¹ã«
                      .replace(/\s+/g, ' ') // é€£ç¶šã™ã‚‹ã‚¹ãƒšãƒ¼ã‚¹ã‚’1ã¤ã«
                      .trim();
        }

        function checkAnswer(isVoice = false) {
            if (!isGameRunning) return;
            const val = input.value;
            if (!val) return;

            // å…¥åŠ›ã•ã‚ŒãŸå€¤ã‚’æ­£è¦åŒ–
            const normalizedInput = normalizeString(val);

            let hitIndex = -1, leftMostX = 1000;
            for (let i = 0; i < targets.length; i++) {
                // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚‚æ­£è¦åŒ–ã—ã¦æ¯”è¼ƒ
                const normalizedTarget = normalizeString(targets[i].word.en);
                
                if (normalizedTarget === normalizedInput) {
                    if (targets[i].x < leftMostX) { leftMostX = targets[i].x; hitIndex = i; }
                }
            }
            if (hitIndex !== -1) {
                const target = targets[hitIndex];
                
                // --- ã‚¹ã‚³ã‚¢è¨ˆç®— (Time Bonus) ---
                let points = 50 + Math.floor(target.x * 2);
                score += points;
                scoreEl.innerText = score;

                // äºˆæ¸¬å°„æ’ƒ
                const travelTimeFrames = 20; 
                const predictedMovePercent = target.speed * travelTimeFrames;
                const futureXPercent = target.x - predictedMovePercent;
                const futureXPixel = (futureXPercent / 100) * window.innerWidth;
                const rect = target.el.getBoundingClientRect(); 
                const targetY = rect.top + rect.height / 2;

                rotateCannon(futureXPixel, targetY);
                shootBullet(futureXPixel, targetY); 
                
                setTimeout(() => {
                    createExplosion(target.el);
                    createHitEffect(target.el, points); 
                    target.el.remove();
                    targets.splice(hitIndex, 1);
                    playSound('hit');
                }, 400); 
                input.value = ''; 
                input.classList.remove('border-red-500');
            } else {
                shootMissBullet(); 
                if (!isVoice) {
                    input.classList.add('border-red-500');
                    setTimeout(() => input.classList.remove('border-red-500'), 300);
                    playSound('miss');
                }
                input.value = ''; 
            }
        }

        function rotateCannon(targetX, targetY) {
             const cannonRect = document.getElementById('cannon-base').getBoundingClientRect();
             const cannonX = cannonRect.left + cannonRect.width / 2;
             const cannonY = cannonRect.bottom; 
             const dx = targetX - cannonX;
             const dy = targetY - cannonY;
             const angleRad = Math.atan2(dy, dx);
             const angleDeg = (angleRad * 180 / Math.PI) + 90;
             cannonWrapper.style.transform = `rotate(${angleDeg}deg)`;
        }

        function shootBullet(endX, endY, isMiss = false) {
            const startX = window.innerWidth / 2;
            const startY = window.innerHeight - 80; 
            const bullet = document.createElement('div');
            bullet.className = 'bullet';
            effectsContainer.appendChild(bullet);
            bullet.style.left = startX + 'px';
            bullet.style.top = startY + 'px';
            if(isMiss) {
                bullet.style.opacity = '0.7';
                bullet.style.boxShadow = '0 0 5px #fff';
            }
            requestAnimationFrame(() => {
                bullet.style.left = endX + 'px';
                bullet.style.top = endY + 'px';
                if(isMiss) bullet.style.transform = 'scale(0.2)';
            });
            setTimeout(() => { bullet.remove(); }, 400); 
        }

        function shootMissBullet() {
            let target = null, minX = 1000;
            for(let t of targets) { if(t.x < minX && t.x > 0) { minX = t.x; target = t; } }
            
            let targetX, targetY;
            if (target) {
                const rect = target.el.getBoundingClientRect();
                targetX = rect.left + rect.width / 2;
                targetY = rect.top - 80; 
                rotateCannon(targetX, targetY); 
            } else {
                targetX = window.innerWidth / 2;
                targetY = window.innerHeight / 2 - 100;
                cannonWrapper.style.transform = `rotate(0deg)`;
            }
            shootBullet(targetX, targetY, true);
        }

        function createHitEffect(targetEl, points) {
            const rect = targetEl.getBoundingClientRect();
            const effect = document.createElement('div');
            effect.className = 'score-popup japanese-font';
            effect.innerText = `+${points}`; // ç‚¹æ•°ã‚’è¡¨ç¤º
            effect.style.left = (rect.left + 20) + 'px';
            effect.style.top = (rect.top - 20) + 'px';
            effectsContainer.appendChild(effect);
            setTimeout(() => effect.remove(), 800);
        }

        function createExplosion(targetEl) {
            const rect = targetEl.getBoundingClientRect();
            const cx = rect.left + rect.width / 2;
            const cy = rect.top + rect.height / 2;
            const colors = ['#ffeb3b', '#ff5252', '#ffffff', '#ffa726'];
            for(let i=0; i<12; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                p.style.left = cx + 'px';
                p.style.top = cy + 'px';
                effectsContainer.appendChild(p);
                const angle = Math.random() * Math.PI * 2;
                const dist = 30 + Math.random() * 50;
                const tx = Math.cos(angle) * dist;
                const ty = Math.sin(angle) * dist;
                p.animate([
                    { transform: `translate(0, 0) scale(1)`, opacity: 1 },
                    { transform: `translate(${tx}px, ${ty}px) scale(0)`, opacity: 0 }
                ], { duration: 400 + Math.random() * 200, easing: 'ease-out' }).onfinish = () => p.remove();
            }
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Alt') document.querySelectorAll('.debug-hint').forEach(el => el.style.opacity = '1');
        });
        document.addEventListener('keyup', (e) => {
            if (e.key === 'Alt') document.querySelectorAll('.debug-hint').forEach(el => el.style.opacity = '0');
        });

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«åˆæœŸè¡¨ç¤ºæ›´æ–°
        window.onload = () => {
            renderLocalRanking();
        }
    </script>
</body>
</html>
