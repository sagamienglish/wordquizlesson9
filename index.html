<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Â§èÁ•≠„Çä Ëã±ÂçòË™ûÂ∞ÑÁöÑ (Lesson 9)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Reggae+One&family=M_PLUS_Rounded_1c:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background-color: #1a1a2e; /* Â§úÁ©∫„ÅÆËâ≤ */
            background-image: radial-gradient(#2d2d44 1px, transparent 1px);
            background-size: 20px 20px;
            overflow: hidden;
            touch-action: manipulation;
        }

        /* ÂíåÈ¢®„Éï„Ç©„É≥„Éà */
        .japanese-font {
            font-family: 'Reggae One', cursive;
        }

        /* ÊèêÁÅØ„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes swing {
            0% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
            100% { transform: rotate(-5deg); }
        }
        .lantern {
            animation: swing 3s infinite ease-in-out;
            transform-origin: top center;
        }

        /* „Çø„Éº„Ç≤„ÉÉ„ÉàÔºàÊú®„ÅÆÊú≠Ôºâ */
        .target-card {
            background: #e6b422; /* ÈáëËâ≤„Å£„ÅΩ„ÅÑÊú® */
            background: linear-gradient(to bottom, #f3d060, #c49a03);
            border: 2px solid #5c4033;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            position: absolute;
            transition: transform 0.2s, opacity 0.2s;
            white-space: nowrap;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            width: 160px; 
            height: 90px;
            overflow: hidden;
        }
        .target-card::before {
            content: '';
            position: absolute;
            top: -10px;
            width: 20px;
            height: 20px;
            background-color: #d1d5db; /* Á¥ê„ÅÆËâ≤ */
            border-radius: 50%;
            z-index: -1;
        }

        /* Âºæ„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        .bullet {
            position: absolute;
            width: 16px;
            height: 16px;
            background-color: #fff;
            border-radius: 50%;
            box-shadow: 0 0 10px #fff, 0 0 20px #ff00de;
            z-index: 100; 
            pointer-events: none;
            transition: all 0.4s linear; /* Á≠âÈÄüÁõ¥Á∑öÈÅãÂãï„ÅÆÊñπ„ÅåÁãô„Å£„Å¶„ÇãÊÑü„ÅåÂá∫„Çã */
        }

        /* Á†¥Â£ä„Ç®„Éï„Çß„ÇØ„ÉàÔºà„Éë„Éº„ÉÜ„Ç£„ÇØ„É´Ôºâ */
        .particle {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 110;
        }
        
        /* „Éí„ÉÉ„ÉàÊôÇ„ÅÆ„Çπ„Ç≥„Ç¢Ë°®Á§∫ */
        .score-popup {
            position: absolute;
            color: #ffeb3b;
            font-weight: bold;
            font-size: 2rem;
            text-shadow: 2px 2px 0 #000;
            pointer-events: none;
            z-index: 120;
            animation: score-float 0.8s ease-out forwards;
        }
        @keyframes score-float {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            50% { transform: translateY(-30px) scale(1.2); opacity: 1; }
            100% { transform: translateY(-60px) scale(1); opacity: 0; }
        }

        /* ÂÖ•Âäõ„Ç®„É™„Ç¢„ÅÆ„Çπ„Çø„Ç§„É´ */
        .wood-panel {
            background-color: #8b5a2b;
            background-image: repeating-linear-gradient(45deg, rgba(0,0,0,0.05) 0px, rgba(0,0,0,0.05) 2px, transparent 2px, transparent 4px);
            border-top: 4px solid #5c3a1e;
        }
        
        /* Èü≥Â£∞Ë™çË≠ò‰∏≠„ÅÆÊ≥¢ÂΩ¢„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes pulse-ring {
            0% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(255, 82, 82, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(255, 82, 82, 0); }
            100% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(255, 82, 82, 0); }
        }
        .listening {
            animation: pulse-ring 1.5s infinite;
            background-color: #ff5252 !important;
        }

        /* Â••Ë°å„ÅçÊÑü„ÇíÂá∫„Åô„Åü„ÇÅ„ÅÆËÉåÊôØ„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥Ë™øÊï¥ */
        .depth-overlay {
            background: linear-gradient(to bottom, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0) 100%);
            pointer-events: none;
        }
        
        /* Èï∑„ÅÑÊó•Êú¨Ë™û„ÅÆ„Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫Ë™øÊï¥ */
        .text-adjust { font-size: 1.1rem; }
        .text-adjust-small { font-size: 0.9rem; }
        .text-adjust-tiny { font-size: 0.75rem; }

        /* Â§ßÁ†≤ÔºàÈäÉÔºâ„ÅÆ„Éá„Ç∂„Ç§„É≥ */
        #cannon-base {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 80px;
            background: #4a4a4a;
            border-radius: 50% 50% 0 0;
            z-index: 40;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.5);
        }
        #cannon-barrel-wrapper {
            position: absolute;
            bottom: 20px; /* Â§ßÁ†≤„ÅÆÂõûËª¢Ëª∏ */
            left: 50%;
            width: 0;
            height: 0;
            z-index: 39;
            transition: transform 0.1s ease-out;
        }
        #cannon-barrel {
            position: absolute;
            bottom: 0;
            left: -12px;
            width: 24px;
            height: 80px;
            background: linear-gradient(90deg, #333, #666, #333);
            border: 2px solid #222;
            border-radius: 4px 4px 0 0;
            transform-origin: center bottom;
        }
        /* „Ç™„Éº„Éê„Éº„É¨„Ç§ÂÖ±ÈÄö */
        .overlay-screen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 9999;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        /* BGM„Éú„Çø„É≥„Çπ„Çø„Ç§„É´ */
        .bgm-btn-on { @apply text-yellow-400 border-yellow-400; }
        .bgm-btn-off { @apply text-gray-500 border-gray-500; }

        /* ‰ªÆÊÉ≥„Ç≠„Éº„Éú„Éº„Éâ„ÅÆ„Çπ„Çø„Ç§„É´ */
        .key-btn {
            @apply bg-gray-700 text-white rounded font-bold shadow active:bg-gray-600 select-none touch-manipulation;
            height: 40px;
        }
        .key-btn:active {
            transform: translateY(2px);
            box-shadow: none;
        }
    </style>
</head>
<body class="h-screen flex flex-col text-white">

    <!-- „Éò„ÉÉ„ÉÄ„Éº -->
    <div class="relative z-10 bg-opacity-80 bg-black pt-2 pb-4 shadow-lg border-b-4 border-red-800 flex-shrink-0">
        <!-- ÊèêÁÅØË£ÖÈ£æ -->
        <div class="absolute top-0 left-0 w-full flex justify-around pointer-events-none -mt-2">
            <div class="lantern w-12 h-16 bg-red-600 rounded-lg border-t-8 border-b-8 border-black flex items-center justify-center shadow-lg"><span class="text-black font-bold text-xl japanese-font">Á•≠</span></div>
            <div class="lantern w-12 h-16 bg-white rounded-lg border-t-8 border-b-8 border-black flex items-center justify-center shadow-lg animation-delay-500"><span class="text-red-600 font-bold text-xl japanese-font">Â∞Ñ</span></div>
            <div class="lantern w-12 h-16 bg-red-600 rounded-lg border-t-8 border-b-8 border-black flex items-center justify-center shadow-lg animation-delay-1000"><span class="text-black font-bold text-xl japanese-font">ÁöÑ</span></div>
            <div class="lantern w-12 h-16 bg-white rounded-lg border-t-8 border-b-8 border-black flex items-center justify-center shadow-lg animation-delay-1500"><span class="text-red-600 font-bold text-xl japanese-font">Ëã±</span></div>
        </div>

        <div class="container mx-auto px-4 mt-12 grid grid-cols-3 items-end relative">
            <!-- „Çπ„Ç≥„Ç¢ -->
            <div class="text-left">
                <div class="text-sm text-gray-400">Score</div>
                <div class="text-3xl font-bold text-yellow-400 font-mono" id="score">0</div>
            </div>
            
            <!-- „Çø„Ç§„Éà„É´ & „É°„ÉÉ„Çª„Éº„Ç∏ -->
            <div class="text-center flex flex-col items-center justify-end">
                <h1 class="text-xl font-bold japanese-font tracking-widest text-red-100 drop-shadow-md whitespace-nowrap">Lesson 9</h1>
                <div class="text-sm text-yellow-200 h-6 leading-6 font-bold truncate w-full" id="game-message"></div>
            </div>

            <!-- ÊôÇÈñì & BGM„Éú„Çø„É≥ -->
            <div class="text-right flex flex-col items-end justify-end">
                <div class="mb-1 hidden md:block">
                    <!-- „Éá„Éï„Ç©„É´„ÉàON -->
                     <button id="bgm-toggle" class="border-2 rounded-full px-2 py-0.5 text-xs font-bold transition-colors bgm-btn-on" onclick="toggleBGM()">
                        üéµ BGM ON
                    </button>
                </div>
                <div>
                    <span class="text-sm text-gray-400 mr-1">Time</span>
                    <span class="text-3xl font-bold text-white font-mono" id="time">60</span>
                </div>
            </div>
        </div>
        
        <!-- „Çπ„Éû„ÉõÁî®BGM„Çπ„Ç§„ÉÉ„ÉÅ (Áµ∂ÂØæÈÖçÁΩÆ) -->
        <div class="absolute top-2 right-2 md:hidden">
             <button id="bgm-toggle-mobile" class="border rounded-full p-1 text-xs transition-colors bgm-btn-on" onclick="toggleBGM()">üéµ</button>
        </div>
    </div>

    <!-- „Ç≤„Éº„É†„Ç®„É™„Ç¢ -->
    <div id="game-area" class="flex-grow relative overflow-hidden cursor-crosshair bg-gray-900 min-h-0">
        <!-- Â••Ë°å„Åç„Ç∑„É£„Éâ„Ç¶ -->
        <div class="absolute inset-0 depth-overlay z-0"></div>

        <!-- ËÉåÊôØ„ÅÆÊ£ö -->
        <div class="absolute inset-x-0 top-[25%] h-1 bg-yellow-900 shadow-md opacity-40 z-0"></div> <!-- Â•• -->
        <div class="absolute inset-x-0 top-[45%] h-2 bg-yellow-900 shadow-md opacity-50 z-0"></div> <!-- ‰∏≠ -->
        <div class="absolute inset-x-0 top-[65%] h-3 bg-yellow-900 shadow-md opacity-60 z-0"></div> <!-- ÊâãÂâç -->
        
        <!-- Â§ßÁ†≤ -->
        <div id="cannon-container" class="absolute bottom-0 left-1/2 transform -translate-x-1/2 pointer-events-none z-40">
             <div id="cannon-barrel-wrapper">
                 <div id="cannon-barrel"></div>
             </div>
             <div id="cannon-base" class="flex items-center justify-center border-t-4 border-gray-600">
                 <span class="text-yellow-500 font-bold text-2xl japanese-font mt-2">Á•≠</span>
             </div>
        </div>

        <div id="targets-container" class="absolute inset-0 pointer-events-none z-10"></div>
        <div id="effects-container" class="absolute inset-0 pointer-events-none z-50"></div>
    </div>

    <!-- „Éï„ÉÉ„Çø„Éº -->
    <div class="wood-panel p-4 pb-2 relative z-20 flex-shrink-0">
        <div class="max-w-3xl mx-auto flex items-center gap-2 mb-2">
            <div class="flex-grow relative flex gap-2">
                <input type="text" id="answer-input" autocomplete="off" placeholder="„Åì„Åì„Å´Ëã±Ë™û„ÇíÂÖ•Âäõ" 
                    class="w-full bg-white text-gray-900 px-4 py-3 rounded-lg border-4 border-gray-300 focus:border-red-500 focus:outline-none text-xl font-bold shadow-inner"
                    onkeydown="checkEnter(event)">
                
                <button onclick="toggleVirtualKeyboard()" class="bg-gray-700 hover:bg-gray-600 text-white px-3 rounded-lg border-2 border-gray-500 flex items-center justify-center shadow-md active:translate-y-1 transition" title="ÁîªÈù¢„Ç≠„Éº„Éú„Éº„Éâ">
                    <span class="text-2xl">‚å®Ô∏è</span>
                </button>

                <button onclick="checkAnswer()" class="bg-blue-500 hover:bg-blue-600 text-white rounded px-4 font-bold md:hidden shadow-md active:translate-y-1 transition">
                    ÊíÉ„Å§
                </button>
            </div>
            <button id="mic-btn" onclick="toggleSpeech()" class="bg-gray-700 hover:bg-gray-600 text-white p-3 rounded-full shadow-lg transition-all border-2 border-gray-500 flex-shrink-0" title="Èü≥Â£∞ÂÖ•Âäõ">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                </svg>
            </button>
        </div>
        <div class="text-center mb-2 text-xs text-yellow-100 opacity-70">
            Èü≥Â£∞Ë™çË≠ò: <span id="speech-status">OFF</span>
        </div>

        <!-- ‰ªÆÊÉ≥„Ç≠„Éº„Éú„Éº„Éâ -->
        <div id="virtual-keyboard" class="hidden w-full max-w-3xl mx-auto pt-2 pb-1 border-t border-yellow-900/30">
            <div class="flex flex-col gap-1">
                <div class="flex gap-1 justify-center">
                    <button class="key-btn w-[9%]" onclick="vKey('q')">Q</button>
                    <button class="key-btn w-[9%]" onclick="vKey('w')">W</button>
                    <button class="key-btn w-[9%]" onclick="vKey('e')">E</button>
                    <button class="key-btn w-[9%]" onclick="vKey('r')">R</button>
                    <button class="key-btn w-[9%]" onclick="vKey('t')">T</button>
                    <button class="key-btn w-[9%]" onclick="vKey('y')">Y</button>
                    <button class="key-btn w-[9%]" onclick="vKey('u')">U</button>
                    <button class="key-btn w-[9%]" onclick="vKey('i')">I</button>
                    <button class="key-btn w-[9%]" onclick="vKey('o')">O</button>
                    <button class="key-btn w-[9%]" onclick="vKey('p')">P</button>
                </div>
                <div class="flex gap-1 justify-center">
                    <button class="key-btn w-[9%]" onclick="vKey('a')">A</button>
                    <button class="key-btn w-[9%]" onclick="vKey('s')">S</button>
                    <button class="key-btn w-[9%]" onclick="vKey('d')">D</button>
                    <button class="key-btn w-[9%]" onclick="vKey('f')">F</button>
                    <button class="key-btn w-[9%]" onclick="vKey('g')">G</button>
                    <button class="key-btn w-[9%]" onclick="vKey('h')">H</button>
                    <button class="key-btn w-[9%]" onclick="vKey('j')">J</button>
                    <button class="key-btn w-[9%]" onclick="vKey('k')">K</button>
                    <button class="key-btn w-[9%]" onclick="vKey('l')">L</button>
                </div>
                <div class="flex gap-1 justify-center">
                    <button class="key-btn w-[12%] bg-gray-600" onclick="vKey('BS')">‚å´</button>
                    <button class="key-btn w-[9%]" onclick="vKey('z')">Z</button>
                    <button class="key-btn w-[9%]" onclick="vKey('x')">X</button>
                    <button class="key-btn w-[9%]" onclick="vKey('c')">C</button>
                    <button class="key-btn w-[9%]" onclick="vKey('v')">V</button>
                    <button class="key-btn w-[9%]" onclick="vKey('b')">B</button>
                    <button class="key-btn w-[9%]" onclick="vKey('n')">N</button>
                    <button class="key-btn w-[9%]" onclick="vKey('m')">M</button>
                    <button class="key-btn w-[15%] bg-blue-600" onclick="vKey('ENTER')">Enter</button>
                </div>
                 <div class="flex gap-1 justify-center">
                    <button class="key-btn w-[40%]" onclick="vKey(' ')">Space</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- „Çπ„Çø„Éº„Éà„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
    <div id="start-overlay" class="overlay-screen">
        <h2 class="text-4xl md:text-6xl font-bold text-yellow-400 japanese-font mb-2 drop-shadow-[0_0_10px_rgba(255,215,0,0.8)]">Â∞ÑÁöÑÈñãÂßã</h2>
        <p class="mb-4 text-gray-300 text-center px-4">Êó•Êú¨Ë™û„ÇíËã±Ë™û„Å´„Åó„Å¶ÊíÉ„Å°ËêΩ„Å®„ÅõÔºÅ<br>Lesson 9 Part 1~3</p>
        
        <div class="flex flex-col gap-3 w-full max-w-sm px-4">
            <!-- „É¶„Éº„Ç∂„ÉºÂÖ•Âäõ (ÂêçÂâç„Å®„ÇØ„É©„Çπ) -->
            <div class="flex gap-2">
                <div class="flex flex-col w-1/3">
                    <label class="text-sm text-gray-400 mb-1">„ÇØ„É©„Çπ</label>
                    <select id="class-select" class="bg-gray-800 text-white border border-gray-600 rounded px-2 py-2 text-lg">
                        <option value="1">1ÁµÑ</option>
                        <option value="2">2ÁµÑ</option>
                        <option value="3">3ÁµÑ</option>
                        <option value="4">4ÁµÑ</option>
                        <option value="5">5ÁµÑ</option>
                        <option value="6">6ÁµÑ</option>
                        <option value="7">7ÁµÑ</option>
                        <option value="8">8ÁµÑ</option>
                        <option value="9">9ÁµÑ</option>
                        <option value="10">10ÁµÑ</option>
                        <option value="11">11ÁµÑ</option>
                        <option value="12">12ÁµÑ</option>
                    </select>
                </div>
                <div class="flex flex-col w-2/3">
                    <label class="text-sm text-gray-400 mb-1">„Éã„ÉÉ„ÇØ„Éç„Éº„É†</label>
                    <input type="text" id="username-input" class="bg-gray-800 text-white border border-gray-600 rounded px-4 py-2 text-lg text-center" placeholder="ÂêçÂâç" maxlength="10">
                </div>
            </div>

            <!-- Ë®≠ÂÆöÔºöÂá∫È°åÁØÑÂõ≤ -->
            <div class="flex flex-col">
                 <label class="text-sm text-gray-400 mb-1">Âá∫È°åÁØÑÂõ≤</label>
                 <select id="part-selector" class="bg-gray-800 text-white border border-gray-600 rounded px-4 py-2 text-lg">
                     <option value="part1">Lesson 9 Part 1</option>
                     <option value="part2">Lesson 9 Part 2</option>
                     <option value="part3">Lesson 9 Part 3</option>
                     <option value="all" selected>Lesson 9 „Åô„Åπ„Å¶</option>
                 </select>
            </div>
            
            <!-- Ë®≠ÂÆöÔºö„É¢„Éº„ÉâÈÅ∏Êäû -->
            <div class="flex flex-col">
                <label class="text-sm text-gray-400 mb-1">„É¢„Éº„Éâ</label>
                <div class="flex gap-2">
                    <label class="flex-1 cursor-pointer">
                        <input type="radio" name="game-mode" value="ja_to_en" checked class="hidden peer">
                        <div class="border border-gray-500 rounded p-2 text-center peer-checked:bg-red-900 peer-checked:border-red-500 peer-checked:text-white text-gray-400 hover:bg-gray-800 transition">
                            <div class="font-bold">ÁøªË®≥ (Êó•‚ÜíËã±)</div>
                            <div class="text-xs">Ê®ôÊ∫ñ„É¢„Éº„Éâ</div>
                        </div>
                    </label>
                    <label class="flex-1 cursor-pointer">
                        <input type="radio" name="game-mode" value="en_to_en" class="hidden peer">
                        <div class="border border-gray-500 rounded p-2 text-center peer-checked:bg-blue-900 peer-checked:border-blue-500 peer-checked:text-white text-gray-400 hover:bg-gray-800 transition">
                            <div class="font-bold">Ë¶ñÂÜô (Ëã±‚ÜíËã±)</div>
                            <div class="text-xs">ÂàùÂøÉËÄÖÂêë„Åë</div>
                        </div>
                    </label>
                </div>
            </div>

            <button onclick="validateAndStart()" class="mt-2 bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-full text-xl shadow-[0_4px_0_rgb(153,27,27)] active:shadow-none active:translate-y-1 transition japanese-font">
                „Ç≤„Éº„É†„Çπ„Çø„Éº„Éà
            </button>
            
            <!-- „É©„É≥„Ç≠„É≥„Ç∞„Éú„Çø„É≥ -->
            <button onclick="showRanking()" class="mt-1 bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 rounded-full text-sm shadow shadow-yellow-800 transition japanese-font">
                üèÜ „É©„É≥„Ç≠„É≥„Ç∞„ÇíË¶ã„Çã
            </button>
        </div>
    </div>

    <!-- „É©„É≥„Ç≠„É≥„Ç∞„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
    <div id="ranking-overlay" class="overlay-screen hidden">
        <div class="flex justify-between items-center w-full max-w-xl mb-4 px-2">
            <h2 class="text-2xl font-bold text-yellow-400 japanese-font">üèÜ „Éè„Ç§„Çπ„Ç≥„Ç¢</h2>
            
            <!-- „ÇØ„É©„ÇπÁµû„ÇäËæº„Åø (ÂâäÈô§„Éú„Çø„É≥„ÅØÈô§Âéª) -->
            <div class="flex gap-2">
                <select id="ranking-filter-class" onchange="applyRankingFilter()" class="bg-gray-700 text-white text-sm border border-gray-500 rounded px-2 py-1">
                    <option value="all">ÂÖ®„ÇØ„É©„Çπ</option>
                    <option value="1">1ÁµÑ</option>
                    <option value="2">2ÁµÑ</option>
                    <option value="3">3ÁµÑ</option>
                    <option value="4">4ÁµÑ</option>
                    <option value="5">5ÁµÑ</option>
                    <option value="6">6ÁµÑ</option>
                    <option value="7">7ÁµÑ</option>
                    <option value="8">8ÁµÑ</option>
                    <option value="9">9ÁµÑ</option>
                    <option value="10">10ÁµÑ</option>
                    <option value="11">11ÁµÑ</option>
                    <option value="12">12ÁµÑ</option>
                </select>
            </div>
        </div>
        
        <div id="ranking-mode-display" class="text-xs text-gray-400 mb-2"></div>
        
        <div class="w-full max-w-xl bg-gray-800 rounded-lg p-4 max-h-[60vh] overflow-y-auto border border-gray-600">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="text-gray-400 border-b border-gray-600">
                        <th class="p-2 w-10">#</th>
                        <th class="p-2 w-16">Class</th>
                        <th class="p-2">Name</th>
                        <th class="p-2 w-20 text-right">Score</th>
                        <th class="p-2">Title</th>
                        <th class="p-2 text-right text-xs w-20">Date</th>
                    </tr>
                </thead>
                <tbody id="ranking-list" class="text-white">
                    <!-- JS„ÅßÁîüÊàê -->
                    <tr><td colspan="6" class="text-center p-4">Ë™≠„ÅøËæº„Åø‰∏≠...</td></tr>
                </tbody>
            </table>
        </div>
        <button onclick="closeRanking()" class="mt-6 bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-8 rounded-full">
            Èñâ„Åò„Çã
        </button>
    </div>

    <!-- „É™„Ç∂„É´„Éà„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
    <div id="result-overlay" class="overlay-screen hidden">
        <h2 class="text-6xl font-bold text-yellow-400 japanese-font mb-4">ÁµÇ‰∫ÜÔºÅ</h2>
        <div id="result-content" class="text-center mb-6">
            <!-- JS„ÅßÊåøÂÖ• -->
        </div>
        <button onclick="resetGame()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-12 rounded-full text-xl shadow-[0_4px_0_rgb(153,27,27)] active:shadow-none active:translate-y-1 transition japanese-font">
            „ÇÇ„ÅÜ‰∏ÄÂ∫¶ÈÅä„Å∂
        </button>
    </div>

    <!-- Firebase / Local Storage Logic -->
    <script type="module">
        window.useFirebase = false;
        
        if (typeof __firebase_config !== 'undefined') {
            const { initializeApp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
            const { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
            const { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, getDocs, query, where } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");

            const firebaseConfig = JSON.parse(__firebase_config);
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            let currentUser = null;
            
            const ensureAuth = async () => {
                if (auth.currentUser) return auth.currentUser;
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                    return auth.currentUser;
                } catch (e) {
                    console.error("Auth error:", e);
                    window.useFirebase = false;
                    throw e;
                }
            };
            
            ensureAuth().then(() => {
                window.useFirebase = true;
            }).catch(e => console.log("Falling back to local storage"));

            window.saveScoreToCloud = async (username, classId, score) => {
                if (!window.useFirebase) return;
                try {
                    await ensureAuth();
                    const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'scores');
                    await addDoc(colRef, {
                        username: username,
                        classId: classId,
                        score: score,
                        timestamp: new Date().toISOString()
                    });
                } catch (e) {
                    console.error("Cloud save failed:", e);
                }
            };

            window.unsubscribeCloudRanking = null;

            window.startFetchingCloudRanking = async (renderCallback) => {
                if (!window.useFirebase) return;
                try {
                    await ensureAuth();
                    const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'scores');
                    window.unsubscribeCloudRanking = onSnapshot(colRef, (snapshot) => {
                        const scores = [];
                        snapshot.forEach(doc => scores.push(doc.data()));
                        renderCallback(scores, "„ÇØ„É©„Ç¶„Éâ („Åø„Çì„Å™„ÅÆË®òÈå≤)");
                    }, (error) => {
                        console.error("Cloud fetch error:", error);
                        renderCallback([], "„Ç®„É©„Éº: " + error.code);
                    });
                } catch (e) {
                    console.error("Cloud setup error:", e);
                }
            };
            
            // clearCloudRanking„ÅØÂâäÈô§Ôºà„Éú„Çø„É≥Êí§Âéª„ÅÆ„Åü„ÇÅÔºâ
        }
    </script>

    <script>
        // --- „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏ & Áµ±Âêà„É≠„Ç∏„ÉÉ„ÇØ ---
        
        let currentRawScores = [];
        let currentSourceLabel = "";

        function saveScoreLocal(username, classId, score) {
            const data = JSON.parse(localStorage.getItem('shooting_game_scores') || '[]');
            data.push({
                username: username,
                classId: classId,
                score: score,
                timestamp: new Date().toISOString()
            });
            data.sort((a, b) => b.score - a.score);
            const limitData = data.slice(0, 300);
            localStorage.setItem('shooting_game_scores', JSON.stringify(limitData));
        }

        function getRankingLocal() {
            return JSON.parse(localStorage.getItem('shooting_game_scores') || '[]');
        }

        async function saveScore(username, classId, score) {
            saveScoreLocal(username, classId, score);
            if (window.useFirebase && window.saveScoreToCloud) {
                await window.saveScoreToCloud(username, classId, score);
            }
        }

        function onRankingDataReceived(rawScores, sourceLabel) {
            currentRawScores = rawScores;
            currentSourceLabel = sourceLabel;
            applyRankingFilter(); 
        }

        function applyRankingFilter() {
            const filterClass = document.getElementById('ranking-filter-class').value;
            
            let filtered = currentRawScores;
            if (filterClass !== 'all') {
                filtered = currentRawScores.filter(s => String(s.classId) === String(filterClass));
            }

            const bestScores = {};
            filtered.forEach(s => {
                if (!bestScores[s.username] || bestScores[s.username].score < s.score) {
                    bestScores[s.username] = s;
                }
            });

            const finalScores = Object.values(bestScores);
            finalScores.sort((a, b) => b.score - a.score);

            renderRanking(finalScores, currentSourceLabel);
        }

        function renderRanking(scores, sourceLabel) {
            const list = document.getElementById('ranking-list');
            const modeLabel = document.getElementById('ranking-mode-display');
            list.innerHTML = '';
            
            modeLabel.innerText = "„ÇΩ„Éº„Çπ: " + sourceLabel;

            if (scores.length === 0) {
                list.innerHTML = '<tr><td colspan="6" class="text-center p-4">„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</td></tr>';
                return;
            }

            scores.slice(0, 50).forEach((s, index) => {
                const date = s.timestamp ? new Date(s.timestamp).toLocaleDateString() : '-';
                const rankClass = index === 0 ? 'text-yellow-400 font-bold' : (index === 1 ? 'text-gray-300 font-bold' : (index === 2 ? 'text-orange-400 font-bold' : ''));
                const title = getRank(s.score);
                const classDisplay = s.classId ? `${s.classId}ÁµÑ` : '-';

                const row = `
                    <tr class="border-b border-gray-700 hover:bg-gray-700">
                        <td class="p-2 ${rankClass}">${index + 1}</td>
                        <td class="p-2 text-sm text-gray-300">${classDisplay}</td>
                        <td class="p-2 font-bold truncate max-w-[100px]">${s.username}</td>
                        <td class="p-2 text-right font-mono text-lg">${s.score}</td>
                        <td class="p-2 text-xs truncate max-w-[120px] text-yellow-200">${title}</td>
                        <td class="p-2 text-right text-xs text-gray-500">${date}</td>
                    </tr>
                `;
                list.insertAdjacentHTML('beforeend', row);
            });
        }

        function showRanking() {
            document.getElementById('ranking-overlay').classList.remove('hidden');
            const list = document.getElementById('ranking-list');
            list.innerHTML = '<tr><td colspan="6" class="text-center p-4">Ë™≠„ÅøËæº„Åø‰∏≠...</td></tr>';

            setTimeout(() => {
                if (window.useFirebase && window.startFetchingCloudRanking) {
                    window.startFetchingCloudRanking(onRankingDataReceived);
                } else {
                    const localScores = getRankingLocal();
                    onRankingDataReceived(localScores, "„Åì„ÅÆÁ´ØÊú´„ÅÆ„Åø („Ç™„Éï„É©„Ç§„É≥)");
                }
            }, 500);
        }

        function closeRanking() {
            document.getElementById('ranking-overlay').classList.add('hidden');
            if (window.unsubscribeCloudRanking) {
                window.unsubscribeCloudRanking();
                window.unsubscribeCloudRanking = null;
            }
        }

        // --- „Ç≤„Éº„É†„Éá„Éº„Çø (Lesson 9) ---
        const wordData = {
            part1: [
                { ja: '„Éã„É•„Éº„Çπ„Ç≠„É£„Çπ„Çø„Éº', en: 'newscaster' },
                { ja: 'Ë¶≥Ë°Ü', en: 'spectator' },
                { ja: '„Åò„Å£„Å®Ë¶ã„Çã', en: 'stare' },
                { ja: 'ÁîªÈù¢, „Çπ„ÇØ„É™„Éº„É≥', en: 'screen' },
                { ja: '‰ºöÂ†¥', en: 'venue' },
                { ja: '„É≠„Ç±„ÉÉ„Éà„Ç®„É≥„Ç∏„É≥„ÅÆ', en: 'rocket-powered' },
                { ja: 'ÂèÇÂä†„Åô„Çã', en: 'participate' },
                { ja: 'Ôºà‰ºöÁ§æ„ÉªÁµÑÁπî„Å™„Å©Ôºâ„ÇíË®≠Á´ã„Åô„Çã', en: 'set up' },
                { ja: 'ÔΩû„ÇíÂøúÊè¥„Åô„Çã', en: 'cheer for' },
                { ja: 'Á´∂„ÅÜ', en: 'compete' }
            ],
            part2: [
                { ja: '‚Ä¶„ÅÆÁï•Ë™û„Åß', en: 'short for' },
                { ja: '‚Ä¶„ÇíÊåá„Åô', en: 'refer to' },
                { ja: 'ÁµÑÁπî„Åï„Çå„Åü', en: 'organized' },
                { ja: 'Áî®Ë™û', en: 'term' },
                { ja: '‰∫∫Ê∞ó', en: 'popularity' },
                { ja: 'ÂÖ¨Âºè„ÅÆ', en: 'official' },
                { ja: 'ÊÄ•ÊøÄ„Å´', en: 'sharply' },
                { ja: 'Â•®Â≠¶Èáë', en: 'scholarship' },
                { ja: 'Â§ß‰ºö', en: 'competition' },
                { ja: 'ÂßîÂì°‰ºö', en: 'committee' }
            ],
            part3: [
                { ja: '‚Ä¶„ÇíÊÄù„ÅÑ„Å§„Åè', en: 'think of' },
                { ja: '„Ç≥„É°„É≥„ÉÜ„Éº„Çø„Éº', en: 'commentator' },
                { ja: 'Ë∫´‰ΩìÁöÑ„Å™', en: 'physical' },
                { ja: 'Á≤æÁ•ûÁöÑ„Å™', en: 'mental' },
                { ja: 'Á¥†Êó©„ÅÑ', en: 'quick' },
                { ja: 'ÂèçÂøú', en: 'response' },
                { ja: 'ÈõÜ‰∏≠', en: 'concentration' },
                { ja: 'Êà¶Áï•', en: 'strategy' },
                { ja: '„Éì„Ç∂', en: 'visa' },
                { ja: 'Âà©ÁÇπ', en: 'advantage' },
                { ja: '‚Ä¶„Å´Èñ¢‰øÇ„Å™„Åè', en: 'regardless of' },
                { ja: '„ÉÅ„Éº„É†„ÉØ„Éº„ÇØ', en: 'teamwork' },
                { ja: '‚Ä¶„Å†„Åë„Çå„Å©„ÇÇ', en: 'although' },
                { ja: 'ÂøÉÈÖç„Åó„Å¶, (ÊÅê„Çå„Å¶)', en: 'afraid' },
                { ja: 'ÁÑ°ÈßÑ', en: 'waste' },
                { ja: 'ÊîøÂ∫ú', en: 'government' },
                { ja: 'Ë™ç„ÇÅ„Çã', en: 'recognize' },
                { ja: 'Âäõ', en: 'strength' }
            ]
        };

        // --- Â§âÊï∞ ---
        let currentWords = [];
        let targets = [];
        let score = 0;
        let timeLeft = 60;
        let gameInterval;
        let spawnInterval;
        let timerInterval;
        let isGameRunning = false;
        let speechRecognition;
        let isListening = false;
        let isBgmOn = true; 
        let bgmInterval;
        let gameMode = 'ja_to_en'; 
        let isVirtualKeyboardOn = false;
        let currentPlayerName = "Guest";
        let currentPlayerClass = "1"; 
        
        // DOMË¶ÅÁ¥†
        const gameArea = document.getElementById('game-area');
        const targetsContainer = document.getElementById('targets-container');
        const effectsContainer = document.getElementById('effects-container');
        const input = document.getElementById('answer-input');
        const scoreEl = document.getElementById('score');
        const timeEl = document.getElementById('time');
        const messageEl = document.getElementById('game-message');
        const micBtn = document.getElementById('mic-btn');
        const speechStatus = document.getElementById('speech-status');
        const cannonWrapper = document.getElementById('cannon-barrel-wrapper');

        // Èü≥Â£∞Ë™çË≠ò
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            speechRecognition = new SpeechRecognition();
            speechRecognition.lang = 'en-US'; 
            speechRecognition.continuous = true; 
            speechRecognition.interimResults = false;
            speechRecognition.onresult = (event) => {
                const last = event.results.length - 1;
                // „ÇØ„É™„Éº„Éã„É≥„Ç∞„ÅÆ„ÅøÔºà„Éè„Ç§„Éï„É≥Èô§Âéª„ÅØ„Åó„Å™„ÅÑ„ÄÅraw„ÇíÈÄÅ„ÇãÔºâ
                const transcript = event.results[last][0].transcript.trim().toLowerCase().replace(/[.?]/g, '');
                input.value = transcript;
                checkAnswer(true); 
                messageEl.innerText = `Èü≥Â£∞Ë™çË≠ò: ${transcript}`;
                messageEl.classList.remove('text-yellow-200');
                messageEl.classList.add('text-green-300');
                setTimeout(() => {
                    if(messageEl.innerText.includes(transcript)) {
                        messageEl.innerText = '';
                        messageEl.classList.add('text-yellow-200');
                        messageEl.classList.remove('text-green-300');
                    }
                }, 2000);
            };
            speechRecognition.onend = () => {
                if (isListening && isGameRunning) speechRecognition.start();
                else { isListening = false; updateMicUI(); }
            };
            speechRecognition.onerror = (event) => {
                if(event.error === 'not-allowed') {
                    showToast("„Éû„Ç§„ÇØ„ÅÆ‰ΩøÁî®„ÅåË®±ÂèØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì");
                    isListening = false;
                    updateMicUI();
                }
            };
        } else {
            micBtn.style.display = 'none';
            speechStatus.innerText = "ÈùûÂØæÂøú„Éñ„É©„Ç¶„Ç∂";
        }

        function toggleSpeech() {
            if (!speechRecognition) return;
            if (isListening) { isListening = false; speechRecognition.stop(); }
            else { isListening = true; speechRecognition.start(); }
            updateMicUI();
        }

        function updateMicUI() {
            if (isListening) {
                micBtn.classList.add('listening');
                speechStatus.innerText = "ON (Ë©±„Åó„Å¶„Åè„Å†„Åï„ÅÑ)";
                speechStatus.classList.add('text-red-400');
            } else {
                micBtn.classList.remove('listening');
                speechStatus.innerText = "OFF";
                speechStatus.classList.remove('text-red-400');
            }
        }

        function showToast(msg) {
            const toast = document.createElement('div');
            toast.className = 'absolute bottom-24 left-1/2 transform -translate-x-1/2 bg-black bg-opacity-70 text-white px-4 py-2 rounded pointer-events-none transition-opacity duration-500 z-[100]';
            toast.innerText = msg;
            gameArea.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 500);
            }, 1500);
        }

        // --- ÁîªÈù¢„Ç≠„Éº„Éú„Éº„Éâ ---
        function toggleVirtualKeyboard() {
            isVirtualKeyboardOn = !isVirtualKeyboardOn;
            const kb = document.getElementById('virtual-keyboard');
            
            if (isVirtualKeyboardOn) {
                kb.classList.remove('hidden');
                // OS„Ç≠„Éº„Éú„Éº„Éâ„ÇíÂá∫„Åï„Å™„ÅÑ„Åü„ÇÅ„Å´readonly„Å´„Åô„Çã
                input.setAttribute('readonly', 'readonly');
            } else {
                kb.classList.add('hidden');
                input.removeAttribute('readonly');
            }
            // „É¨„Ç§„Ç¢„Ç¶„ÉàÂÜçË®àÁÆó„ÅÆ„Åü„ÇÅ„Å´„Éï„Ç©„Éº„Ç´„Çπ„Çí„ÅÇ„Åà„Å¶Â§ñ„Åô
            input.blur();
        }

        function vKey(key) {
            if (key === 'ENTER') {
                checkAnswer();
            } else if (key === 'BS') {
                input.value = input.value.slice(0, -1);
            } else {
                input.value += key;
            }
            // ÂÖ•Âäõ‰∏≠„ÇÇOS„Ç≠„Éº„Éú„Éº„Éâ„ÇíÂá∫„Åï„Å™„ÅÑ
            if(isVirtualKeyboardOn) {
                input.focus();
            }
        }


        // --- „Ç™„Éº„Éá„Ç£„Ç™ ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function toggleBGM() {
            isBgmOn = !isBgmOn;
            const btn = document.getElementById('bgm-toggle');
            const btnMobile = document.getElementById('bgm-toggle-mobile');
            
            if (isBgmOn) {
                if (audioCtx.state === 'suspended') audioCtx.resume();
                btn.innerText = "üéµ BGM ON";
                btn.classList.remove('bgm-btn-off'); btn.classList.add('bgm-btn-on');
                btnMobile.classList.remove('bgm-btn-off'); btnMobile.classList.add('bgm-btn-on');
                startBGM();
            } else {
                btn.innerText = "üéµ BGM OFF";
                btn.classList.remove('bgm-btn-on'); btn.classList.add('bgm-btn-off');
                btnMobile.classList.remove('bgm-btn-on'); btnMobile.classList.add('bgm-btn-off');
                stopBGM();
            }
        }

        function startBGM() {
            let beat = 0;
            const tempo = 130; 
            
            const melodyPattern = [
                1175, 987, 880, 0,  1175, 987, 880, 0,
                1175, 1175, 987, 987, 880, 0, 880, 0,
                1318, 0, 1318, 0, 1175, 987, 880, 0,
                987, 1175, 987, 880, 880, 0, 0, 0
            ];

            clearInterval(bgmInterval);
            bgmInterval = setInterval(() => {
                const t = audioCtx.currentTime;
                const step = beat % 32;

                const drumRhythm = [
                    1, 0, 1, 0, 1, 2, 0, 2,  
                    1, 0, 2, 0, 1, 0, 2, 0,  
                    1, 0, 1, 0, 1, 2, 0, 2,
                    1, 1, 2, 2, 1, 0, 0, 0   
                ];
                
                const d = drumRhythm[step];
                if (d === 1) playTaikoDon(t);
                if (d === 2) playTaikoKa(t);

                const note = melodyPattern[step];
                if (note) playShinobue(t, note, 0.15);

                beat++;
            }, tempo);
        }

        function stopBGM() { clearInterval(bgmInterval); }

        function playTaikoDon(time) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.setValueAtTime(120, time);
            osc.frequency.exponentialRampToValueAtTime(60, time + 0.15);
            gain.gain.setValueAtTime(0.6, time);
            gain.gain.exponentialRampToValueAtTime(0.01, time + 0.2);
            addNoiseBurst(time, 0.05, 0.1);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(time);
            osc.stop(time + 0.2);
        }

        function playTaikoKa(time) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'square';
            osc.frequency.setValueAtTime(400, time);
            gain.gain.setValueAtTime(0.1, time);
            gain.gain.exponentialRampToValueAtTime(0.01, time + 0.05);
            addNoiseBurst(time, 0.05, 0.2); 
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(time);
            osc.stop(time + 0.05);
        }

        function addNoiseBurst(time, duration, vol) {
            const bufferSize = audioCtx.sampleRate * duration;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
            const noise = audioCtx.createBufferSource();
            noise.buffer = buffer;
            const gain = audioCtx.createGain();
            gain.gain.setValueAtTime(vol, time);
            gain.gain.exponentialRampToValueAtTime(0.01, time + duration);
            noise.connect(gain);
            gain.connect(audioCtx.destination);
            noise.start(time);
        }

        function playShinobue(time, freq, dur) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            const lfo = audioCtx.createOscillator();
            const lfoGain = audioCtx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(freq, time);
            lfo.frequency.value = 5; 
            lfoGain.gain.value = 5; 
            lfo.connect(lfoGain);
            lfoGain.connect(osc.frequency);
            lfo.start(time);
            gain.gain.setValueAtTime(0, time);
            gain.gain.linearRampToValueAtTime(0.1, time + 0.05);
            gain.gain.linearRampToValueAtTime(0, time + dur); 
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(time);
            osc.stop(time + dur);
        }

        // --- ÂäπÊûúÈü≥ ---
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const t = audioCtx.currentTime;
            
            if (type === 'hit') {
                addNoiseBurst(t, 0.4, 0.6);
            } else {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(300, t);
                osc.frequency.linearRampToValueAtTime(100, t + 0.2);
                gain.gain.setValueAtTime(0.1, t);
                gain.gain.exponentialRampToValueAtTime(0.01, t + 0.2);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start(t);
                osc.stop(t + 0.2);
            }
        }

        // --- UI Logic & Game Flow ---

        function validateAndStart() {
            const nameInput = document.getElementById('username-input');
            const classInput = document.getElementById('class-select');
            
            const name = nameInput.value.trim();
            const classVal = classInput.value;
            
            if (!name) {
                alert("„Éã„ÉÉ„ÇØ„Éç„Éº„É†„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ");
                return;
            }

            // ‰∏çÈÅ©Âàá„Å™Ë®ÄËëâ„ÉÅ„Çß„ÉÉ„ÇØ
            const badWords = ['„Éê„Ç´', '„Å∞„Åã', '„Ç¢„Éõ', '„ÅÇ„Åª', 'Ê≠ª„Å≠', '„Åó„Å≠', 'ÊÆ∫', 'sex', 'fuck', 'shit', 'bitch', 'kill', 'Â§âÊÖã', '„ÅÜ„Çì„Åì', '„ÉÅ„É≥„Ç≥', '„Éû„É≥„Ç≥']; 
            const checkName = name.toLowerCase();
            for (const word of badWords) {
                if (checkName.includes(word)) {
                    alert("‰∏çÈÅ©Âàá„Å™Ë®ÄËëâ„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇÂà•„ÅÆÂêçÂâç„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
                    return;
                }
            }

            currentPlayerName = name;
            currentPlayerClass = classVal;
            startGame();
        }

        function startGame() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const part = document.getElementById('part-selector').value;
            const modeRadios = document.getElementsByName('game-mode');
            for(const radio of modeRadios) if(radio.checked) gameMode = radio.value;

            if (part === 'all') currentWords = [...wordData.part1, ...wordData.part2, ...wordData.part3];
            else currentWords = [...wordData[part]];
            
            score = 0;
            timeLeft = 60;
            targets = [];
            targetsContainer.innerHTML = '';
            effectsContainer.innerHTML = '';
            scoreEl.innerText = score;
            timeEl.innerText = timeLeft;
            input.value = '';
            input.focus();
            cannonWrapper.style.transform = 'rotate(0deg)';
            document.getElementById('start-overlay').style.display = 'none';
            document.getElementById('result-overlay').style.display = 'none';
            isGameRunning = true;
            messageEl.innerText = "";

            clearInterval(gameInterval);
            gameInterval = setInterval(updateGame, 20); 
            
            clearInterval(spawnInterval);
            const spawnRate = 4000; 
            spawnInterval = setInterval(spawnTarget, spawnRate);

            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                timeEl.innerText = timeLeft;
                if (timeLeft <= 0) endGame();
            }, 1000);
            
            if(isBgmOn) startBGM();

            if(isVirtualKeyboardOn) input.setAttribute('readonly', 'readonly');
        }

        function resetGame() {
            document.getElementById('result-overlay').style.display = 'none';
            document.getElementById('start-overlay').style.display = 'flex';
        }

        function getRank(score) {
            // „Çπ„Éî„Éº„Éâ„Éú„Éº„Éä„Çπ„Åß„Çπ„Ç≥„Ç¢„ÅåÂ¢ó„Åà„ÇÑ„Åô„Åè„Å™„Å£„Åü„Åü„ÇÅ„ÄÅ„É©„É≥„ÇØÂü∫Ê∫ñ„ÇíÂ∞ë„ÅóÂºï„Åç‰∏ä„Åí
            if (score >= 2000) return "‰ºùË™¨„ÅÆÁöÑÂ±ãÁéã üéÜüëë";
            if (score >= 1800) return "Â•áË∑°„ÅÆ„Çπ„Éä„Ç§„Éë„Éº üéØ‚ú®";
            if (score >= 1500) return "Â§èÁ•≠„Çä„ÅÆË¶áËÄÖ üèÆü¶Å";
            if (score >= 1200) return "Â∞ÑÁöÑ„Éû„Çπ„Çø„Éº üî•üî´";
            if (score >= 1000) return "„ÅäÁ•≠„ÇäÂêç‰∫∫ üë∫üèÆ";
            if (score >= 800)  return "ÂáÑËÖï„Éè„É≥„Çø„Éº üê∫";
            if (score >= 600)  return "ÁÜüÁ∑¥„ÅÆÂ∞ÑÊâã üèπ";
            if (score >= 400)  return "ÊúüÂæÖ„ÅÆ„Éõ„Éº„Éó ‚ú®";
            if (score >= 200)  return "ÈßÜ„ÅëÂá∫„Åó„É´„Éº„Ç≠„Éº üî∞";
            return "Ë¶ãÁøí„ÅÑ„ÉÅ„É£„É¨„É≥„Ç∏„É£„Éº ü•ö";
        }

        function endGame() {
            isGameRunning = false;
            clearInterval(gameInterval);
            clearInterval(spawnInterval);
            clearInterval(timerInterval);
            if(isListening) toggleSpeech();
            stopBGM();
            
            const rank = getRank(score);
            saveScore(currentPlayerName, currentPlayerClass, score);

            const overlay = document.getElementById('result-overlay');
            overlay.style.display = 'flex';
            
            const content = document.getElementById('result-content');
            content.innerHTML = `
                <div class="text-2xl mb-2">${currentPlayerClass}ÁµÑ ${currentPlayerName}„Åï„Çì„ÅÆ„Çπ„Ç≥„Ç¢</div>
                <div class="text-yellow-400 text-6xl font-bold font-mono mb-4">${score}</div>
                <div class="text-2xl mt-2 bg-red-900 bg-opacity-50 px-6 py-2 rounded-lg border border-red-500 inline-block">
                    Áß∞Âè∑: <span class="text-white font-bold japanese-font">${rank}</span>
                </div>
            `;
        }

        function spawnTarget() {
            if (!isGameRunning) return;
            const wordData = currentWords[Math.floor(Math.random() * currentWords.length)];
            const laneConfigs = [
                { top: '20%', scale: 0.7, zIndex: 1, speedRatio: 0.8 },
                { top: '40%', scale: 0.85, zIndex: 5, speedRatio: 0.9 },
                { top: '60%', scale: 1.0, zIndex: 10, speedRatio: 1.0 }
            ];
            const config = laneConfigs[Math.floor(Math.random() * laneConfigs.length)];
            const id = Date.now() + Math.random();
            const el = document.createElement('div');
            el.className = 'target-card px-2 py-1'; 
            el.style.top = config.top;
            el.style.left = '100%'; 
            el.style.transform = `scale(${config.scale})`;
            el.style.zIndex = config.zIndex;
            
            let mainText, subText, fontClass;
            if (gameMode === 'en_to_en') {
                mainText = wordData.en;
                subText = wordData.ja; 
                fontClass = "font-bold text-blue-900 mb-1 leading-tight font-sans"; 
            } else {
                mainText = wordData.ja;
                subText = wordData.en;
                fontClass = "font-bold text-red-900 japanese-font mb-1 leading-tight";
            }
            const len = mainText.length;
            if (len > 12) fontClass += " text-adjust-tiny";
            else if (len > 8) fontClass += " text-adjust-small";
            else fontClass += " text-xl";
            
            el.innerHTML = `<div class="${fontClass}">${mainText}</div><div class="text-xs text-yellow-900 opacity-0 debug-hint">${subText}</div>`;
            targetsContainer.appendChild(el);

            const baseSpeed = 0.16;
            targets.push({
                id: id, el: el, word: wordData, x: 100, 
                speed: baseSpeed * config.speedRatio, scale: config.scale, zIndex: config.zIndex
            });
        }

        function updateGame() {
            for (let i = targets.length - 1; i >= 0; i--) {
                let t = targets[i];
                t.x -= t.speed;
                t.el.style.left = t.x + '%';
                if (t.x < -20) { t.el.remove(); targets.splice(i, 1); }
            }
        }

        function checkEnter(e) { if (e.key === 'Enter') checkAnswer(); }

        // „Éè„Ç§„Éï„É≥„Å®„Çπ„Éö„Éº„Çπ„ÇíÊ≠£Ë¶èÂåñ„Åô„ÇãÈñ¢Êï∞
        function normalizeString(str) {
            if (!str) return "";
            return str.toLowerCase()
                      .replace(/-/g, ' ')  // „Éè„Ç§„Éï„É≥„Çí„Çπ„Éö„Éº„Çπ„Å´
                      .replace(/\s+/g, ' ') // ÈÄ£Á∂ö„Åô„Çã„Çπ„Éö„Éº„Çπ„Çí1„Å§„Å´
                      .trim();
        }

        function checkAnswer(isVoice = false) {
            if (!isGameRunning) return;
            const val = input.value;
            if (!val) return;

            // ÂÖ•Âäõ„Åï„Çå„ÅüÂÄ§„ÇíÊ≠£Ë¶èÂåñ
            const normalizedInput = normalizeString(val);

            let hitIndex = -1, leftMostX = 1000;
            for (let i = 0; i < targets.length; i++) {
                // „Çø„Éº„Ç≤„ÉÉ„Éà„ÇÇÊ≠£Ë¶èÂåñ„Åó„Å¶ÊØîËºÉ
                const normalizedTarget = normalizeString(targets[i].word.en);
                
                if (normalizedTarget === normalizedInput) {
                    if (targets[i].x < leftMostX) { leftMostX = targets[i].x; hitIndex = i; }
                }
            }
            if (hitIndex !== -1) {
                const target = targets[hitIndex];
                
                // --- „Çπ„Ç≥„Ç¢Ë®àÁÆó (Time Bonus) ---
                let points = 50 + Math.floor(target.x * 2);
                score += points;
                scoreEl.innerText = score;

                // ‰∫àÊ∏¨Â∞ÑÊíÉ
                const travelTimeFrames = 20; 
                const predictedMovePercent = target.speed * travelTimeFrames;
                const futureXPercent = target.x - predictedMovePercent;
                const futureXPixel = (futureXPercent / 100) * window.innerWidth;
                const rect = target.el.getBoundingClientRect(); 
                const targetY = rect.top + rect.height / 2;

                rotateCannon(futureXPixel, targetY);
                shootBullet(futureXPixel, targetY); 
                
                setTimeout(() => {
                    createExplosion(target.el);
                    createHitEffect(target.el, points); 
                    target.el.remove();
                    targets.splice(hitIndex, 1);
                    playSound('hit');
                }, 400); 
                input.value = ''; 
                input.classList.remove('border-red-500');
            } else {
                shootMissBullet(); 
                if (!isVoice) {
                    input.classList.add('border-red-500');
                    setTimeout(() => input.classList.remove('border-red-500'), 300);
                    playSound('miss');
                }
                input.value = ''; 
            }
        }

        function rotateCannon(targetX, targetY) {
             const cannonRect = document.getElementById('cannon-base').getBoundingClientRect();
             const cannonX = cannonRect.left + cannonRect.width / 2;
             const cannonY = cannonRect.bottom; 
             const dx = targetX - cannonX;
             const dy = targetY - cannonY;
             const angleRad = Math.atan2(dy, dx);
             const angleDeg = (angleRad * 180 / Math.PI) + 90;
             cannonWrapper.style.transform = `rotate(${angleDeg}deg)`;
        }

        function shootBullet(endX, endY, isMiss = false) {
            const startX = window.innerWidth / 2;
            const startY = window.innerHeight - 80; 
            const bullet = document.createElement('div');
            bullet.className = 'bullet';
            effectsContainer.appendChild(bullet);
            bullet.style.left = startX + 'px';
            bullet.style.top = startY + 'px';
            if(isMiss) {
                bullet.style.opacity = '0.7';
                bullet.style.boxShadow = '0 0 5px #fff';
            }
            requestAnimationFrame(() => {
                bullet.style.left = endX + 'px';
                bullet.style.top = endY + 'px';
                if(isMiss) bullet.style.transform = 'scale(0.2)';
            });
            setTimeout(() => { bullet.remove(); }, 400); 
        }

        function shootMissBullet() {
            let target = null, minX = 1000;
            for(let t of targets) { if(t.x < minX && t.x > 0) { minX = t.x; target = t; } }
            
            let targetX, targetY;
            if (target) {
                const rect = target.el.getBoundingClientRect();
                targetX = rect.left + rect.width / 2;
                targetY = rect.top - 80; 
                rotateCannon(targetX, targetY); 
            } else {
                targetX = window.innerWidth / 2;
                targetY = window.innerHeight / 2 - 100;
                cannonWrapper.style.transform = `rotate(0deg)`;
            }
            shootBullet(targetX, targetY, true);
        }

        function createHitEffect(targetEl, points) {
            const rect = targetEl.getBoundingClientRect();
            const effect = document.createElement('div');
            effect.className = 'score-popup japanese-font';
            effect.innerText = `+${points}`; // ÁÇπÊï∞„ÇíË°®Á§∫
            effect.style.left = (rect.left + 20) + 'px';
            effect.style.top = (rect.top - 20) + 'px';
            effectsContainer.appendChild(effect);
            setTimeout(() => effect.remove(), 800);
        }

        function createExplosion(targetEl) {
            const rect = targetEl.getBoundingClientRect();
            const cx = rect.left + rect.width / 2;
            const cy = rect.top + rect.height / 2;
            const colors = ['#ffeb3b', '#ff5252', '#ffffff', '#ffa726'];
            for(let i=0; i<12; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                p.style.left = cx + 'px';
                p.style.top = cy + 'px';
                effectsContainer.appendChild(p);
                const angle = Math.random() * Math.PI * 2;
                const dist = 30 + Math.random() * 50;
                const tx = Math.cos(angle) * dist;
                const ty = Math.sin(angle) * dist;
                p.animate([
                    { transform: `translate(0, 0) scale(1)`, opacity: 1 },
                    { transform: `translate(${tx}px, ${ty}px) scale(0)`, opacity: 0 }
                ], { duration: 400 + Math.random() * 200, easing: 'ease-out' }).onfinish = () => p.remove();
            }
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Alt') document.querySelectorAll('.debug-hint').forEach(el => el.style.opacity = '1');
        });
        document.addEventListener('keyup', (e) => {
            if (e.key === 'Alt') document.querySelectorAll('.debug-hint').forEach(el => el.style.opacity = '0');
        });
    </script>
</body>
</html>
